<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FireNavi - í™”ì´ì–´ë‚´ë¹„ | ì‹¤ì‹œê°„ ëŒ€í”¼ ì‹œë®¬ë ˆì´ì…˜</title>
  <link rel="stylesheet" href="../css/style.css">
  <style>
    /* ===== AI Recommend Panel Scrollbar ===== */
    #ffRecommendPanel::-webkit-scrollbar { width: 6px; }
    #ffRecommendPanel::-webkit-scrollbar-track { background: transparent; }
    #ffRecommendPanel::-webkit-scrollbar-thumb { background: #93C5FD; border-radius: 3px; }
    #ffRecommendPanel::-webkit-scrollbar-thumb:hover { background: #60A5FA; }

    /* ===== Deck Selector Buttons ===== */
    .deck-btn {
      padding: 8px 20px;
      font-size: 0.85rem;
      font-weight: 600;
      border: 2px solid #334155;
      border-radius: 8px;
      background: linear-gradient(135deg, #1E293B, #334155);
      color: #94A3B8;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .deck-btn:hover {
      background: linear-gradient(135deg, #1E3A5F, #2563EB);
      color: #fff;
      border-color: #3B82F6;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59,130,246,0.3);
    }
    .deck-btn.active {
      background: linear-gradient(135deg, #1D4ED8, #3B82F6);
      color: #fff;
      border-color: #60A5FA;
      box-shadow: 0 4px 16px rgba(59,130,246,0.4), inset 0 1px 0 rgba(255,255,255,0.15);
    }

    /* ===== Simulation Page Specific Styles ===== */
    .sim-layout {
      display: grid;
      grid-template-columns: 1fr 360px;
      gap: var(--space-lg);
      margin: var(--space-lg) 0;
    }

    @media (max-width: 1024px) {
      .sim-layout {
        grid-template-columns: 1fr;
      }
    }

    .sim-main {
      min-width: 0;
    }

    .canvas-wrap {
      position: relative;
      background: linear-gradient(145deg, #080E18, #0F1724);
      border: 1px solid rgba(51,65,85,0.4);
      border-radius: var(--radius-lg);
      overflow: hidden;
      box-shadow: 0 12px 40px rgba(0,0,0,0.2);
    }

    .canvas-wrap canvas {
      display: block;
      width: 100%;
      cursor: crosshair;
    }

    .canvas-overlay-msg {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: var(--text-muted);
      font-size: 1rem;
      pointer-events: none;
      text-align: center;
      line-height: 1.8;
      opacity: 0.7;
      transition: opacity 0.3s;
    }

    .canvas-overlay-msg.hidden {
      opacity: 0;
    }

    .controls-bar {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: var(--space-sm);
      padding: var(--space-md) var(--space-lg);
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      margin-top: var(--space-md);
      box-shadow: var(--shadow-card);
    }

    .ctrl-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .ctrl-label {
      font-size: 0.8rem;
      color: var(--text-muted);
      white-space: nowrap;
    }

    .ctrl-val {
      font-size: 0.8rem;
      color: var(--fire-orange);
      font-weight: 600;
      min-width: 30px;
      text-align: center;
    }

    .ctrl-range {
      -webkit-appearance: none;
      appearance: none;
      width: 100px;
      height: 6px;
      border-radius: 3px;
      background: var(--border);
      outline: none;
    }

    .ctrl-range::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--fire-orange);
      cursor: pointer;
      border: 2px solid var(--bg-primary);
    }

    .ctrl-range::-moz-range-thumb {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--fire-orange);
      cursor: pointer;
      border: 2px solid var(--bg-primary);
    }

    .ctrl-sep {
      width: 1px;
      height: 28px;
      background: var(--border);
      margin: 0 4px;
    }

    .sim-btn {
      font-family: var(--font-main);
    }

    .sim-btn.active-mode {
      box-shadow: 0 0 0 2px var(--fire-orange);
    }

    /* --- Stats Panel --- */
    .stats-panel {
      display: flex;
      flex-direction: column;
      gap: var(--space-md);
    }

    .stats-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: var(--space-lg);
      box-shadow: var(--shadow-card);
      position: relative;
      overflow: hidden;
    }
    .stats-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
    }
    .stats-card:nth-child(1)::before { background: linear-gradient(90deg, #2563EB, #3B82F6); }
    .stats-card:nth-child(1) { background: linear-gradient(180deg, rgba(219,234,254,0.2) 0%, #FFFFFF 40%); }
    .stats-card:nth-child(2)::before { background: linear-gradient(90deg, #059669, #10B981); }
    .stats-card:nth-child(2) { background: linear-gradient(180deg, rgba(209,250,229,0.2) 0%, #FFFFFF 40%); }
    .stats-card:nth-child(3)::before { background: linear-gradient(90deg, #7C3AED, #A78BFA); }
    .stats-card:nth-child(3) { background: linear-gradient(180deg, rgba(237,233,254,0.2) 0%, #FFFFFF 40%); }

    .stats-card h3 {
      font-size: 0.85rem;
      font-weight: 700;
      color: var(--text-secondary);
      margin-bottom: var(--space-md);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .stat-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255,255,255,0.04);
    }

    .stat-row:last-child {
      border-bottom: none;
    }

    .stat-row .label {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .stat-row .value {
      font-size: 1.1rem;
      font-weight: 700;
      font-family: var(--font-mono);
    }

    .stat-row .value.green { color: var(--safe); }
    .stat-row .value.blue { color: var(--info); }
    .stat-row .value.red { color: var(--danger); }
    .stat-row .value.orange { color: var(--fire-orange); }
    .stat-row .value.white { color: var(--text-primary); }

    .evac-progress-wrap {
      margin-top: var(--space-md);
    }

    .evac-progress-wrap .prog-label {
      display: flex;
      justify-content: space-between;
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .evac-progress {
      height: 10px;
      background: var(--bg-primary);
      border-radius: 5px;
      overflow: hidden;
    }

    .evac-progress-fill {
      height: 100%;
      background: var(--gradient-safe);
      border-radius: 5px;
      transition: width 0.3s;
      width: 0%;
    }

    .legend-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-top: var(--space-sm);
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .legend-rect {
      width: 14px;
      height: 10px;
      border-radius: 2px;
      flex-shrink: 0;
    }

    /* --- Algorithm Section --- */
    .algo-grid {
      display: grid;
      grid-auto-flow: column;
      grid-auto-columns: 1fr;
      gap: var(--space-lg);
      margin-top: var(--space-lg);
    }

    .algo-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: var(--space-xl);
      box-shadow: var(--shadow-card);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    .algo-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
    }
    .algo-card:nth-child(1) { background: linear-gradient(160deg, rgba(219,234,254,0.25) 0%, #FFFFFF 30%); border-color: rgba(37,99,235,0.12); }
    .algo-card:nth-child(1)::before { background: linear-gradient(90deg, #2563EB, #3B82F6); }
    .algo-card:nth-child(1) h4 { color: #1D4ED8; }

    .algo-card:nth-child(2) { background: linear-gradient(160deg, rgba(254,226,226,0.25) 0%, #FFFFFF 30%); border-color: rgba(229,62,62,0.12); }
    .algo-card:nth-child(2)::before { background: linear-gradient(90deg, #E53E3E, #ED8936); }
    .algo-card:nth-child(2) h4 { color: #C2410C; }

    .algo-card:nth-child(3) { background: linear-gradient(160deg, rgba(209,250,229,0.25) 0%, #FFFFFF 30%); border-color: rgba(5,150,105,0.12); }
    .algo-card:nth-child(3)::before { background: linear-gradient(90deg, #059669, #10B981); }
    .algo-card:nth-child(3) h4 { color: #047857; }

    .algo-card:nth-child(4) { background: linear-gradient(160deg, rgba(237,233,254,0.25) 0%, #FFFFFF 30%); border-color: rgba(124,58,237,0.12); }
    .algo-card:nth-child(4)::before { background: linear-gradient(90deg, #7C3AED, #A78BFA); }
    .algo-card:nth-child(4) h4 { color: #6D28D9; }

    .algo-card:nth-child(5) { background: linear-gradient(160deg, rgba(207,250,254,0.25) 0%, #FFFFFF 30%); border-color: rgba(8,145,178,0.12); }
    .algo-card:nth-child(5)::before { background: linear-gradient(90deg, #0891B2, #22D3EE); }
    .algo-card:nth-child(5) h4 { color: #0E7490; }

    .algo-card:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-lg);
    }

    .algo-card h4 {
      font-size: 1rem;
      font-weight: 700;
      margin-bottom: var(--space-sm);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .algo-card p {
      font-size: 0.875rem;
      color: var(--text-secondary);
      line-height: 1.7;
    }

    .algo-card .formula-inline {
      display: block;
      margin: var(--space-sm) 0;
      padding: var(--space-sm) var(--space-md);
      background: var(--bg-primary);
      border-radius: var(--radius-sm);
      font-family: var(--font-mono);
      font-size: 0.8rem;
      color: var(--fire-orange);
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <div class="page-wrapper">
    <!-- NAVIGATION -->
    <nav class="top-nav">
      <div class="nav-inner">
        <a href="../index.html" class="nav-brand">
          <span class="fire-icon">&#x1F525;</span>
          <span>FireNavi</span>
          <span class="nav-tagline">í˜¸í™”ìœ ëŒì„  í™”ì¬ ëŒ€í”¼ AI ë‚´ë¹„ê²Œì´ì…˜</span>
        </a>
        <ul class="nav-links">
          <li><a href="../index.html">Dashboard</a></li>
          <li><a href="a-technical-formulation.html">A. ê¸°ìˆ  ìˆ˜ì‹í™”</a></li>
          <li><a href="b-industrial-architecture.html">B. ì‚°ì—… ì•„í‚¤í…ì²˜</a></li>
          <li><a href="c-shipyard-proposal.html">C. ì¡°ì„ ì†Œ ì œì•ˆ</a></li>
          <li><a href="d-insurance-risk-model.html">D. ë³´í—˜ ë¦¬ìŠ¤í¬</a></li>
          <li><a href="simulation.html" class="active">ì‹œë®¬ë ˆì´ì…˜</a></li>
          <li><a href="risk-map.html">ìœ„í—˜ì§€ë„</a></li>
          <li><a href="route-optimizer.html">ê²½ë¡œìµœì í™”</a></li>
        </ul>
        <button class="nav-mobile-toggle">&#9776;</button>
      </div>
    </nav>

    <!-- PAGE HEADER -->
    <div class="container">
      <div class="page-header">
        <div class="breadcrumb">
          <a href="../index.html">Dashboard</a>
          <span>/</span>
          <span>ì‹¤ì‹œê°„ ëŒ€í”¼ ì‹œë®¬ë ˆì´ì…˜</span>
        </div>
        <h1 class="page-title">ì‹¤ì‹œê°„ í™”ì¬ ëŒ€í”¼ ì‹œë®¬ë ˆì´ì…˜</h1>
        <p class="page-desc">
          í¬ë£¨ì¦ˆì„  ê° ì¸µ(5~9ì¸µ) ë°í¬ í‰ë©´ë„ë¥¼ ì„ íƒí•˜ì—¬ í™”ì¬ë¥¼ ë°°ì¹˜í•˜ê³ , ìŠ¹ê° ì—ì´ì „íŠ¸ë“¤ì˜ ëŒ€í”¼ ê³¼ì •ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ê´€ì°°í•©ë‹ˆë‹¤.
          A* ê²½ë¡œíƒìƒ‰, Social Force Model, Beer-Lambert ê°€ì‹œì„±, Advection-Diffusion ì—°ê¸° í™•ì‚°, ë‹¤ì¤‘ ìœ„í—˜ ë¦¬ìŠ¤í¬ ë§µ, ê±´ê°• ìƒíƒœ ì¸ì§€ ëŒ€í”¼ ë“± <b>9ê°€ì§€ ìˆ˜ë¦¬ ëª¨ë¸</b>ì´ í†µí•© ì ìš©ë©ë‹ˆë‹¤.
        </p>
      </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="container main-content">
      <div class="sim-layout">
        <!-- LEFT: Canvas + Controls -->
        <div class="sim-main">
          <!-- Deck Selector Buttons -->
          <div id="deckSelector" style="display:flex; gap:6px; margin-bottom:10px;">
            <span style="font-size:0.82rem; font-weight:600; color:var(--text-muted); display:flex; align-items:center; margin-right:4px;">ì¸µ ì„ íƒ:</span>
            <button class="deck-btn active" data-deck="5" onclick="selectDeck(5)">5ì¸µ</button>
            <button class="deck-btn" data-deck="6" onclick="selectDeck(6)">6ì¸µ</button>
            <button class="deck-btn" data-deck="7" onclick="selectDeck(7)">7ì¸µ</button>
            <button class="deck-btn" data-deck="8" onclick="selectDeck(8)">8ì¸µ</button>
            <button class="deck-btn" data-deck="9" onclick="selectDeck(9)">9ì¸µ</button>
          </div>
          <div class="canvas-wrap" id="canvasWrap">
            <canvas id="simCanvas" width="900" height="500"></canvas>
            <div class="canvas-overlay-msg" id="overlayMsg">
              í™”ì¬ ìœ„ì¹˜ë¥¼ í´ë¦­í•˜ì—¬ ì„¤ì •í•˜ì„¸ìš”<br>
              <span style="font-size:0.8rem;">"í™”ì¬ ë°°ì¹˜ ëª¨ë“œ" ë²„íŠ¼ì„ ë¨¼ì € ëˆ„ë¥´ì„¸ìš”</span>
            </div>
          </div>

          <!-- Controls -->
          <div class="controls-bar">
            <button class="sim-btn sim-btn--primary" id="btnFire">í™”ì¬ ë°°ì¹˜ ëª¨ë“œ</button>
            <span id="fireCountBadge" style="display:none;background:#FEE2E2;color:#DC2626;font-size:0.8rem;font-weight:700;padding:4px 10px;border-radius:12px;border:1px solid #FECACA;">0ê°œ ë°°ì¹˜</span>
            <button class="sim-btn sim-btn--safe" id="btnEvac" disabled>ëŒ€í”¼ ì‹œì‘</button>
            <button class="sim-btn" id="btnFirefighter" disabled style="background:linear-gradient(135deg,#2563EB,#3B82F6);color:#fff;border:1px solid #1D4ED8;">ğŸš’ ì†Œë°©ê´€ íˆ¬ì…</button>
            <span id="ffBadge" style="display:none;background:#DBEAFE;color:#1D4ED8;font-size:0.8rem;font-weight:700;padding:4px 10px;border-radius:12px;border:1px solid #93C5FD;">0ëª… íˆ¬ì…</span>
            <button class="sim-btn" id="btnReset">ì´ˆê¸°í™”</button>
            <button class="sim-btn" id="btnRiskMap" style="background:linear-gradient(135deg,#7C3AED,#A78BFA);color:#fff;border:1px solid #6D28D9;font-size:0.78rem;">ìœ„í—˜ì§€ë„</button>

            <div class="ctrl-sep"></div>

            <div class="ctrl-group">
              <span class="ctrl-label">ì†ë„</span>
              <input type="range" class="ctrl-range" id="speedSlider" min="0.5" max="3" step="0.25" value="1">
              <span class="ctrl-val" id="speedVal">1x</span>
            </div>

            <div class="ctrl-sep"></div>

            <div class="ctrl-group">
              <span class="ctrl-label">ìŠ¹ê° ìˆ˜</span>
              <input type="number" class="ctrl-input" id="countInput" min="1" step="1" value="40" style="width:70px; height:28px; background:var(--bg-secondary); border:1px solid var(--border); border-radius:6px; color:var(--fire-orange); font-weight:600; font-size:0.85rem; text-align:center; outline:none;">
              <span class="ctrl-val" id="countVal">ëª…</span>
            </div>
          </div>
        </div>

        <!-- RIGHT: Stats Panel -->
        <div class="stats-panel">
          <!-- Real-time Stats -->
          <div class="stats-card">
            <h3>ì‹¤ì‹œê°„ í˜„í™©</h3>
            <div class="stat-row">
              <span class="label">ëŒ€í”¼ ì™„ë£Œ ì¸ì›</span>
              <span class="value green" id="statEvacuated">0</span>
            </div>
            <div class="stat-row">
              <span class="label">ë‚¨ì€ ì¸ì›</span>
              <span class="value blue" id="statRemaining">0</span>
            </div>
            <div class="stat-row">
              <span class="label">ìœ„í—˜ êµ¬ì—­ ì¸ì›</span>
              <span class="value red" id="statAtRisk">0</span>
            </div>
            <div class="stat-row">
              <span class="label">ê²½ê³¼ ì‹œê°„</span>
              <span class="value orange" id="statTime">0.0s</span>
            </div>
            <div class="stat-row">
              <span class="label">í‰ê·  ëŒ€í”¼ ì‹œê°„</span>
              <span class="value white" id="statAvgTime">--</span>
            </div>
            <div class="stat-row">
              <span class="label">ìœ„í—˜ êµ¬ì—­ ìˆ˜</span>
              <span class="value red" id="statDangerZones">0</span>
            </div>
            <div class="stat-row">
              <span class="label">í‰ê·  ê°€ì‹œì„±</span>
              <span class="value white" id="statVisibility">30m</span>
            </div>
            <div class="stat-row" style="border-top:1px solid var(--border);padding-top:6px;margin-top:4px;">
              <span class="label" style="font-size:0.75rem;color:var(--text-muted);">ìŠ¹ê° ìœ í˜• ë¶„í¬</span>
              <span class="value" style="font-size:0.7rem;" id="statTypeDist">--</span>
            </div>

            <div class="evac-progress-wrap">
              <div class="prog-label">
                <span>ëŒ€í”¼ ì§„í–‰ë¥ </span>
                <span id="progPercent">0%</span>
              </div>
              <div class="evac-progress">
                <div class="evac-progress-fill" id="progBar"></div>
              </div>
            </div>
          </div>

          <!-- Legend -->
          <div class="stats-card">
            <h3>ë²”ë¡€ (Legend)</h3>
            <div class="legend-grid">
              <div class="legend-item">
                <span class="legend-rect" style="background:#556677;"></span> ë³µë„ (Corridor)
              </div>
              <div class="legend-item">
                <span class="legend-rect" style="background:#2a3a4e;border:1px solid #4a5a6e;"></span> ê°ì‹¤ (Cabin)
              </div>
              <div class="legend-item">
                <span class="legend-rect" style="background:rgba(237,137,54,0.2);border:1px solid #ED8936;"></span> ë ˆìŠ¤í† ë‘
              </div>
              <div class="legend-item">
                <span class="legend-rect" style="background:rgba(128,90,213,0.2);border:1px solid #805AD5;"></span> ê¸°ê´€ì‹¤
              </div>
              <div class="legend-item">
                <span class="legend-rect" style="background:rgba(56,161,105,0.25);border:1px solid #38A169;"></span> ì§‘ê²°ì§€
              </div>
              <div class="legend-item">
                <span class="legend-rect" style="background:#38A169;"></span> ì¶œêµ¬ (Exit)
              </div>
              <div class="legend-item">
                <span class="legend-dot" style="background:#4A90D9;"></span> ê±´ê°•í•œ ì„±ì¸
              </div>
              <div class="legend-item">
                <span class="legend-dot" style="background:#F59E0B;"></span> ê³ ë ¹ì
              </div>
              <div class="legend-item">
                <span class="legend-dot" style="background:#8B5CF6;"></span> ì–´ë¦°ì´
              </div>
              <div class="legend-item">
                <span class="legend-dot" style="background:#EC4899;"></span> íœ ì²´ì–´
              </div>
              <div class="legend-item">
                <span class="legend-dot" style="background:#14B8A6;"></span> ì„ì‚°ë¶€
              </div>
              <div class="legend-item">
                <span class="legend-dot" style="background:#EF4444;"></span> ë¶€ìƒì
              </div>
              <div class="legend-item">
                <span class="legend-dot" style="background:#E53E3E;box-shadow:0 0 6px rgba(229,62,62,0.8);"></span> í™”ì¬
              </div>
              <div class="legend-item">
                <span class="legend-dot" style="background:rgba(120,120,120,0.5);"></span> ì—°ê¸°
              </div>
              <div class="legend-item">
                <span class="legend-rect" style="background:#3182CE;border:1px solid #63B3ED;"></span> ê³„ë‹¨
              </div>
              <div class="legend-item">
                <span class="legend-dot" style="background:#38A169;"></span> ëŒ€í”¼ ì™„ë£Œ
              </div>
              <div class="legend-item">
                <span class="legend-rect" style="background:rgba(236,201,75,0.6);border:1px solid #ECC94B;width:8px;height:8px;"></span> ì¶œì…êµ¬
              </div>
              <div class="legend-item">
                <span class="legend-rect" style="background:#DC2626;width:8px;height:8px;"></span> ì†Œí™”ê¸°
              </div>
              <div class="legend-item">
                <span class="legend-dot" style="background:#F97316;"></span> ì†Œí™” ì¤‘
              </div>
              <div class="legend-item">
                <span class="legend-dot" style="background:transparent;border:2px solid #EF4444;width:8px;height:8px;border-radius:50%;"></span> ê²½ë¡œíƒìƒ‰ ì¤‘
              </div>
            </div>
          </div>

          <!-- Simulation Status -->
          <div class="stats-card">
            <h3>ì‹œë®¬ë ˆì´ì…˜ ìƒíƒœ</h3>
            <div class="stat-row">
              <span class="label">ëª¨ë“œ</span>
              <span class="value white" id="statMode" style="font-size:0.85rem;">ëŒ€ê¸° ì¤‘</span>
            </div>
            <div class="stat-row">
              <span class="label">í™”ì¬ ë°œìƒ ìˆ˜</span>
              <span class="value orange" id="statFireCount">0</span>
            </div>
            <div class="stat-row">
              <span class="label">í™”ì¬ í™•ì‚° ë°˜ê²½</span>
              <span class="value red" id="statFireRadius">0px</span>
            </div>
            <div class="stat-row">
              <span class="label">ì†Œí™”ê¸° ì”ì—¬</span>
              <span class="value orange" id="statFECount">-</span>
            </div>
            <div class="stat-row">
              <span class="label">ì†Œí™” í™œë™ ì¤‘</span>
              <span class="value orange" id="statFEActive">0ëª…</span>
            </div>
            <div class="stat-row">
              <span class="label">ê²½ë¡œíƒìƒ‰ ì¤‘</span>
              <span class="value red" id="statStuck">0ëª…</span>
            </div>
            <div class="stat-row" style="border-top:1px solid var(--border);padding-top:8px;margin-top:8px;">
              <span class="label">ğŸš’ ì†Œë°©ê´€ íˆ¬ì…</span>
              <span class="value blue" id="statFF">0ëª…</span>
            </div>
            <div class="stat-row">
              <span class="label">ğŸ”¥ ì§„ì•• ì™„ë£Œ</span>
              <span class="value green" id="statFFDone">0ê±´</span>
            </div>
          </div>
        </div>
      </div>

      <!-- AI Firefighter Recommendation Panel (ì˜¤ë¥¸ìª½ ì•„ë˜ í”Œë¡œíŒ… ì°½) -->
      <div id="ffRecommendPanel" style="display:none; position:fixed; bottom:20px; right:20px; width:420px; max-height:70vh; overflow-y:auto; background:linear-gradient(135deg, rgba(219,234,254,0.95), rgba(239,246,255,0.98)); border:2px solid #3B82F6; border-radius:16px; padding:20px; box-shadow:0 20px 60px rgba(0,0,0,0.3), 0 0 20px rgba(59,130,246,0.2); z-index:1000; backdrop-filter:blur(10px);">
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px;">
          <h3 style="margin:0; font-size:1.05rem; color:#1D4ED8; display:flex; align-items:center; gap:8px;">
            <span style="font-size:1.3rem;">ğŸ¤–</span> AI ì¶”ì²œ
          </h3>
          <div style="display:flex; align-items:center; gap:8px;">
            <span style="font-size:0.7rem; font-weight:500; color:#64748B;">FireNavi AI Engine</span>
            <button onclick="document.getElementById('ffRecommendPanel').style.display='none'" style="background:none; border:1px solid #CBD5E1; border-radius:6px; cursor:pointer; font-size:1rem; padding:2px 8px; color:#64748B; line-height:1;">&times;</button>
          </div>
        </div>
        <div id="ffRecommendContent" style="font-size:0.83rem; color:#1E293B; line-height:1.7;"></div>
      </div>

      <!-- Algorithm Info -->
      <div class="content-section" style="margin-top: var(--space-xl);">
        <h2>ì•Œê³ ë¦¬ì¦˜ ìƒì„¸ (Algorithm Details)</h2>
        <p>
          ë³¸ ì‹œë®¬ë ˆì´ì…˜ì€ í¬ë£¨ì¦ˆì„  í™”ì¬ ë°œìƒ ì‹œ ìŠ¹ê° ëŒ€í”¼ ê³¼ì •ì„ ëª¨ì‚¬í•©ë‹ˆë‹¤.
          <b>9ê°€ì§€ ìˆ˜ë¦¬ ëª¨ë¸</b>ê³¼ ë¬¼ë¦¬ ê¸°ë°˜ í™”ì¬/ì—°ê¸° í™•ì‚°, êµ°ì¤‘ ì—­í•™ì´ í†µí•© ì ìš©ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
        </p>

        <div class="algo-grid">
          <!-- A* Pathfinding -->
          <div class="algo-card">
            <h4><span style="color:var(--info);">&#x1F9ED;</span> A* ë™ì  ìœ„í—˜ íšŒí”¼ ê²½ë¡œíƒìƒ‰</h4>
            <p>
              ê° ìŠ¹ê° ì—ì´ì „íŠ¸ëŠ” A* ì•Œê³ ë¦¬ì¦˜ ë³€í˜•ì„ ì‚¬ìš©í•˜ì—¬ ê°€ì¥ ê°€ê¹Œìš´ ì•ˆì „í•œ ì¶œêµ¬ê¹Œì§€ì˜ ìµœì  ê²½ë¡œë¥¼ íƒìƒ‰í•©ë‹ˆë‹¤.
              í™”ì¬ ë° ì—°ê¸° êµ¬ì—­ì— ë†’ì€ ë¹„ìš©(cost penalty)ì„ ë¶€ì—¬í•˜ì—¬ ìœ„í—˜ ì§€ì—­ì„ ë™ì ìœ¼ë¡œ íšŒí”¼í•©ë‹ˆë‹¤.
            </p>
            <span class="formula-inline">
              f(n) = g(n) + h(n) + R(n)<br>
              R(n) = w_fire &middot; D_fire(n) + w_smoke &middot; D_smoke(n)
            </span>
            <p>
              ì—¬ê¸°ì„œ R(n)ì€ ìœ„í—˜ ê°€ì¤‘ì¹˜ í•¨ìˆ˜ì´ë©°, í™”ì¬ ê±°ë¦¬ì™€ ì—°ê¸° ë°€ë„ì— ë”°ë¼ ë…¸ë“œë³„ ì¶”ê°€ ë¹„ìš©ì„ ì‚°ì •í•©ë‹ˆë‹¤.
              ê²½ë¡œëŠ” í™”ì¬ í™•ì‚°ì— ë”°ë¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ì¬ê³„ì‚°ë©ë‹ˆë‹¤.
            </p>
          </div>

          <!-- Social Force Model -->
          <div class="algo-card">
            <h4><span style="color:var(--info);">&#x1F9D1;&#x200D;&#x1F91D;&#x200D;&#x1F9D1;</span> Social Force Model (Eq. 1)</h4>
            <p>
              Helbing & MolnÃ¡r ì‚¬íšŒì  í˜ ëª¨ë¸ì„ ì ìš©í•˜ì—¬ ìŠ¹ê° ê°„ ìì—°ìŠ¤ëŸ¬ìš´ ì¶©ëŒ íšŒí”¼ì™€ êµ°ì¤‘ ì—­í•™ì„ ëª¨ì‚¬í•©ë‹ˆë‹¤.
              ê° ì—ì´ì „íŠ¸ì— ì‘ìš©í•˜ëŠ” í˜ì€ ëª©í‘œ ë°©í–¥ë ¥, ì‚¬íšŒì  ë°˜ë°œë ¥, ë²½ë©´ ë°˜ë°œë ¥ìœ¼ë¡œ êµ¬ì„±ë©ë‹ˆë‹¤.
            </p>
            <span class="formula-inline">
              F_i = F_desire + &Sigma; F_social + &Sigma; F_wall + F_random<br>
              F_social = A &middot; exp(-d_ij / B), &nbsp; A=2.0, B=15px
            </span>
            <p>
              ê°€ê¹Œìš´ ìŠ¹ê° ê°„ ì§€ìˆ˜ ê°ì†Œ ë°˜ë°œë ¥ì´ ì‘ìš©í•˜ì—¬ ë³‘ëª© êµ¬ê°„ì—ì„œì˜ ìì—°ìŠ¤ëŸ¬ìš´ ë¶„ì‚° íš¨ê³¼ë¥¼ êµ¬í˜„í•©ë‹ˆë‹¤.
            </p>
          </div>

          <!-- Fire Spread + Advection-Diffusion -->
          <div class="algo-card">
            <h4><span style="color:var(--danger);">&#x1F525;</span> í™”ì¬ í™•ì‚° + ì´ë¥˜-í™•ì‚° ëª¨ë¸ (Eq. 5-7)</h4>
            <p>
              í™”ì¬ëŠ” ë°œí™” ì§€ì ìœ¼ë¡œë¶€í„° ë¹„ì„ í˜• í™•ì‚°ë©ë‹ˆë‹¤.
              ì—°ê¸°ëŠ” Navier-Stokes ê¸°ë°˜ ì´ë¥˜-í™•ì‚°(Advection-Diffusion) ë°©ì •ì‹ìœ¼ë¡œ ë°”ëŒ ë°©í–¥ì— ë”°ë¼ ë¹„ëŒ€ì¹­ í™•ì‚°ë©ë‹ˆë‹¤.
            </p>
            <span class="formula-inline">
              r_fire(t) = r_0 + &alpha; &middot; t^1.3<br>
              &part;C/&part;t + <b>u</b>&middot;&nabla;C = D&middot;&nabla;&sup2;C + S<br>
              ì—°ê¸° ì¤‘ì‹¬ ì´ë™: x_s += u_wind &middot; cos(&theta;) &middot; dt
            </span>
            <p>
              í•´ìƒ ë°”ëŒì˜ í’í–¥/í’ì†ì´ ì—°ê¸° í™•ì‚° ë°©í–¥ê³¼ í˜•íƒœ(íƒ€ì› ë¹„ìœ¨)ì— ì˜í–¥ì„ ì¤ë‹ˆë‹¤.
              í’í•˜ ë°©í–¥ìœ¼ë¡œ ì—°ê¸°ê°€ ë” ë„“ê²Œ í™•ì‚°ë©ë‹ˆë‹¤.
            </p>
          </div>

          <!-- Beer-Lambert Visibility -->
          <div class="algo-card">
            <h4><span style="color:var(--text-muted);">&#x1F576;&#xFE0F;</span> Beer-Lambert ê°€ì‹œì„± ëª¨ë¸ (Eq. 10)</h4>
            <p>
              ì—°ê¸° ë†ë„ì— ë”°ë¥¸ ê°€ì‹œ ê±°ë¦¬ë¥¼ Beer-Lambert ë²•ì¹™ìœ¼ë¡œ ì‚°ì¶œí•©ë‹ˆë‹¤.
              ê°€ì‹œì„± ì €í•˜ëŠ” ìŠ¹ê° ì´ë™ ì†ë„ì— ì§ì ‘ ì˜í–¥ì„ ì¤ë‹ˆë‹¤.
            </p>
            <span class="formula-inline">
              V(C) = K / C, &nbsp; K = 8 (ë°œê´‘ í‘œì§€íŒ ê¸°ì¤€)<br>
              v_smoke = v_base &middot; max(0.1, V/30)
            </span>
            <p>
              ë§‘ì€ ê³µê¸°(30m ê°€ì‹œê±°ë¦¬)ì—ì„œ ì™„ì „ ì†ë„, ë†ì—°(1m ì´í•˜)ì—ì„œ ìµœëŒ€ 90% ì†ë„ ê°ì†Œ.
              í†µê³„ íŒ¨ë„ì—ì„œ ì‹¤ì‹œê°„ í‰ê·  ê°€ì‹œì„±ì„ ëª¨ë‹ˆí„°ë§í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </p>
          </div>

          <!-- Risk Map -->
          <div class="algo-card">
            <h4><span style="color:#7C3AED;">&#x1F5FA;&#xFE0F;</span> ë‹¤ì¤‘ ìœ„í—˜ ë™ì  ë¦¬ìŠ¤í¬ ë§µ (Eq. 11)</h4>
            <p>
              í™”ì¬, ì—°ê¸°, êµ¬ì¡° ì†ìƒ, êµ°ì¤‘ ë°€ë„ë¥¼ ê°€ì¤‘ í•©ì‚°í•œ ì¢…í•© ìœ„í—˜ë„ ì§€ë„ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ìƒì„±í•©ë‹ˆë‹¤.
              "ìœ„í—˜ì§€ë„" ë²„íŠ¼ìœ¼ë¡œ íˆíŠ¸ë§µ ì˜¤ë²„ë ˆì´ë¥¼ í™œì„±í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </p>
            <span class="formula-inline">
              R(x,y,t) = w_F&middot;F + w_S&middot;S + w_D&middot;D + w_C&middot;C<br>
              w_F=0.35, w_S=0.30, w_D=0.20, w_C=0.15
            </span>
            <p>
              ë…¹ìƒ‰(ì•ˆì „) â†’ í™©ìƒ‰(ì£¼ì˜) â†’ ì ìƒ‰(ìœ„í—˜) ì»¬ëŸ¬ë§µìœ¼ë¡œ ì‹œê°í™”ë˜ë©°,
              A* ê²½ë¡œíƒìƒ‰ì˜ ë¹„ìš© í•¨ìˆ˜ì—ë„ ë°˜ì˜ë©ë‹ˆë‹¤.
            </p>
          </div>

          <!-- Health-Aware Routing -->
          <div class="algo-card">
            <h4><span style="color:#14B8A6;">&#x2695;&#xFE0F;</span> ê±´ê°• ìƒíƒœ ì¸ì§€ ëŒ€í”¼ (Eq. 20-22)</h4>
            <p>
              ìŠ¹ê°ì„ 6ê°€ì§€ ìœ í˜•(ê±´ê°•í•œ ì„±ì¸, ê³ ë ¹ì, ì–´ë¦°ì´, íœ ì²´ì–´, ì„ì‚°ë¶€, ë¶€ìƒì)ìœ¼ë¡œ ë¶„ë¥˜í•˜ê³ 
              ê°œì¸ë³„ ì´ë™ëŠ¥ë ¥ê³„ìˆ˜(Î¼_i)ì— ë”°ë¼ ì†ë„ë¥¼ ì¡°ì ˆí•©ë‹ˆë‹¤.
            </p>
            <span class="formula-inline">
              &mu;_i &sim; U[&mu;_min, &mu;_max] (ìœ í˜•ë³„ ë²”ìœ„)<br>
              v_i = &mu;_i &middot; v_base &middot; f(age, condition)<br>
              Priority = (1 - &mu;_i) &middot; w_health + d_fire / d_max &middot; w_prox
            </span>
            <p>
              ì´ë™ëŠ¥ë ¥ì´ ë‚®ì€ ìŠ¹ê°ì—ê²Œ ë†’ì€ ëŒ€í”¼ ìš°ì„ ìˆœìœ„ê°€ ë¶€ì—¬ë˜ë©°,
              ì‹œê°ì ìœ¼ë¡œ ê° ìœ í˜•ë³„ ê³ ìœ  ìƒ‰ìƒìœ¼ë¡œ êµ¬ë¶„ë©ë‹ˆë‹¤.
            </p>
          </div>

          <!-- Crowd Density -->
          <div class="algo-card">
            <h4><span style="color:var(--warning);">&#x1F465;</span> Greenshields êµ°ì¤‘ ë°€ì§‘ë„ ëª¨ë¸ (Eq. 4)</h4>
            <p>
              êµí†µë¥˜ ì´ë¡ ì˜ Greenshields ê¸°ë³¸ ë‹¤ì´ì–´ê·¸ë¨ì„ êµ°ì¤‘ ë³´í–‰ì— ì ìš©í•©ë‹ˆë‹¤.
              ì¢ì€ ë³µë„ë‚˜ ì¶œêµ¬ ê·¼ì²˜ì—ì„œ ë³‘ëª©ì´ ë°œìƒí•˜ë©´ ì†ë„ê°€ ë¹„ì„ í˜•ì ìœ¼ë¡œ ê°ì†Œí•©ë‹ˆë‹¤.
            </p>
            <span class="formula-inline">
              v(&rho;) = v_max &middot; (1 - &rho;/&rho;_max)^&gamma;<br>
              &gamma; = 1.4 (ë°€ì§‘ë„ ê°ë„ ê³„ìˆ˜)
            </span>
            <p>
              ê°œì¸ë³„ ê±´ê°• ìƒíƒœì— ë”°ë¥¸ v_maxì™€ ê²°í•©í•˜ì—¬ ì‹¤ì§ˆ ì´ë™ ì†ë„ê°€ ê²°ì •ë©ë‹ˆë‹¤.
              ì¶œêµ¬ ê·¼ì²˜ ì§‘ì¤‘ ì‹œ ìë™ ë¶„ì‚° ë¡œì§ì´ ì ìš©ë©ë‹ˆë‹¤.
            </p>
          </div>

          <!-- ì¶œì…êµ¬ ì•ˆë‚´ -->
          <div class="content-section" style="margin-top:16px;">
            <h4><span style="color:var(--fire-yellow);">&#x1F6AA;</span> ê°ì‹¤ ì¶œì…êµ¬ ë° ì´ë™ ê²½ë¡œ</h4>
            <p>
              ê° ê°ì‹¤ì—ëŠ” ë³µë„ ë°©í–¥ìœ¼ë¡œ 1ê°œì˜ ì¶œì…êµ¬(ë…¸ë€ìƒ‰ í‘œì‹œ)ê°€ ìˆìŠµë‹ˆë‹¤.
              ìŠ¹ê°ì€ ë°˜ë“œì‹œ ì¶œì…êµ¬ë¥¼ í†µí•´ ë³µë„ë¡œ ë‚˜ì˜¨ í›„ ì¶œêµ¬ ë˜ëŠ” ê³„ë‹¨ì„ í–¥í•´ ì´ë™í•©ë‹ˆë‹¤.
              ê³„ë‹¨ì— ë„ë‹¬í•œ ìŠ¹ê°ì€ ë‹¤ë¥¸ ì¸µìœ¼ë¡œ ì´ë™í•˜ì—¬ ì•ˆì „í•˜ê²Œ ëŒ€í”¼í•œ ê²ƒìœ¼ë¡œ ê°„ì£¼ë©ë‹ˆë‹¤.
              ë ˆìŠ¤í† ë‘ì€ 4ë°©í–¥(ìƒ/í•˜/ì¢Œ/ìš°) ì¶œì…êµ¬ê°€ ìˆì–´ ë‹¤ì–‘í•œ ê²½ë¡œë¡œ ëŒ€í”¼ ê°€ëŠ¥í•©ë‹ˆë‹¤.
            </p>
            <span class="formula-inline">
              ì´ë™ ê²½ë¡œ: ê°ì‹¤ ë‚´ë¶€ â†’ ì¶œì…êµ¬(doorway) â†’ ë³µë„(corridor) â†’ ê³„ë‹¨(stairway)/ì¶œêµ¬(exit) â†’ ëŒ€í”¼ ì™„ë£Œ
            </span>
          </div>

          <!-- ì†Œí™”ê¸° ì‹œìŠ¤í…œ -->
          <div class="content-section" style="margin-top:16px;">
            <h4><span style="color:var(--danger);">&#x1F9EF;</span> ì†Œí™”ê¸° ì‚¬ìš© ì‹œìŠ¤í…œ (Fire Extinguisher)</h4>
            <p>
              ë³µë„ ë²½ë©´, ê³„ë‹¨ ê·¼ì²˜, ì£¼ìš” êµì°¨ì ì— ì†Œí™”ê¸°(ë¹¨ê°„ ì‹­ì í‘œì‹œ)ê°€ ë°°ì¹˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
              í™”ì¬ë¡œ ëª¨ë“  ëŒ€í”¼ ê²½ë¡œê°€ ì°¨ë‹¨ëœ ìŠ¹ê°ì€ ë‹¤ìŒ ì ˆì°¨ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤:
            </p>
            <ol style="margin-left:20px;line-height:2;">
              <li>ê°€ì¥ ê°€ê¹Œìš´ <b>ì†Œí™”ê¸°</b> ìœ„ì¹˜ë¡œ ì´ë™ (ì£¼í™©ìƒ‰ í‘œì‹œ)</li>
              <li>ì†Œí™”ê¸°ë¥¼ ë“¤ê³  <b>í™”ì¬ ê·¼ì²˜</b>ë¡œ ì ‘ê·¼</li>
              <li><b>3ì´ˆê°„ ì§„ì••</b> í™œë™ ìˆ˜í–‰ (ê¹œë°•ì„ í‘œì‹œ)</li>
              <li>í™”ì¬ ë°˜ê²½ 60% ê°ì†Œ â†’ í†µë¡œ í™•ë³´ í›„ ëŒ€í”¼ ì¬ê°œ</li>
            </ol>
            <span class="formula-inline">
              ì§„ì•• í›„: r_fire â†’ r_fire * 0.4, r_smoke â†’ r_smoke * 0.5<br>
              ì†Œí™”ê¸° 1ê°œë‹¹ 1íšŒ ì‚¬ìš© (ì‚¬ìš© í›„ íšŒìƒ‰ í‘œì‹œ)
            </span>
          </div>
        </div>
      </div>
    </div>

  <script src="../js/main.js"></script>

  <script>
  /* ================================================================
     FireNavi - Cruise Ship Fire Evacuation Simulation
     Canvas-based interactive simulation with A* pathfinding,
     fire/smoke spread, and multi-agent evacuation.
     ================================================================ */
  (function () {
    'use strict';

    // â”€â”€â”€â”€â”€ DOM refs â”€â”€â”€â”€â”€
    const canvas = document.getElementById('simCanvas');
    const ctx = canvas.getContext('2d');
    const wrap = document.getElementById('canvasWrap');
    const overlay = document.getElementById('overlayMsg');

    const btnFire = document.getElementById('btnFire');
    const btnEvac = document.getElementById('btnEvac');
    const btnReset = document.getElementById('btnReset');
    const btnFirefighter = document.getElementById('btnFirefighter');
    const ffBadge = document.getElementById('ffBadge');
    const fireCountBadge = document.getElementById('fireCountBadge');
    const speedSlider = document.getElementById('speedSlider');
    const speedVal = document.getElementById('speedVal');
    const countInput = document.getElementById('countInput');
    const countVal = document.getElementById('countVal');

    const statEvacuated = document.getElementById('statEvacuated');
    const statRemaining = document.getElementById('statRemaining');
    const statAtRisk = document.getElementById('statAtRisk');
    const statTime = document.getElementById('statTime');
    const statAvgTime = document.getElementById('statAvgTime');
    const statDangerZones = document.getElementById('statDangerZones');
    const progPercent = document.getElementById('progPercent');
    const progBar = document.getElementById('progBar');
    const statMode = document.getElementById('statMode');
    const statFireCount = document.getElementById('statFireCount');
    const statFireRadius = document.getElementById('statFireRadius');

    // â”€â”€â”€â”€â”€ Constants â”€â”€â”€â”€â”€
    const W = 900, H = 500;
    const CELL = 10; // grid cell size
    const COLS = W / CELL;
    const ROWS = H / CELL;

    // â”€â”€â”€â”€â”€ State â”€â”€â”€â”€â”€
    let currentDeck = 5; // í˜„ì¬ ì„ íƒëœ ì¸µ (5~9ì¸µ)
    let mode = 'idle'; // idle | placing | evacuating | done
    let simSpeed = 1;
    let passengerCount = 40;
    let fires = [];
    let fireExtinguishers = [];
    let passengers = [];
    let firefighters = [];     // ì†Œë°©ê´€ ì—ì´ì „íŠ¸
    let ffDeployMode = false;  // ì†Œë°©ê´€ ë°°ì¹˜ ëª¨ë“œ
    let ffSuppressCount = 0;   // ì§„ì•• ì™„ë£Œ íšŸìˆ˜
    let elapsedTime = 0;
    let evacuatedCount = 0;
    let evacuationTimes = [];
    let animId = null;
    let lastFrameTime = 0;
    let grid = []; // 0=wall, 1=walkable, 3=restaurant, 4=engine, 5=muster, 6=stairway, 7=exit, 8=cabin interior

    // â”€â”€â”€â”€â”€ Wind / Advection-Diffusion (Eq. 5-7) â”€â”€â”€â”€â”€
    // í•´ìƒ ë°”ëŒ ë°©í–¥ (ë¼ë””ì•ˆ, 0=ì˜¤ë¥¸ìª½, PI/2=ì•„ë˜), ì†ë„
    const WIND_DIR = Math.PI * 0.25; // ìš°í•˜í–¥ 45Â°
    const WIND_SPEED = 0.4; // ì •ê·œí™”ëœ ë°”ëŒ ì„¸ê¸° [0,1]

    // Ship layout structures
    let corridors = [];
    let cabins = [];
    let doorways = []; // ê°ì‹¤/êµ¬ì—­ ì¶œì…êµ¬
    let restaurants = [];
    let engineRooms = [];
    let musterStations = [];
    let stairways = [];
    let exits = [];

    // â”€â”€â”€â”€â”€ Responsive Canvas â”€â”€â”€â”€â”€
    function resizeCanvas() {
      const wrapW = wrap.clientWidth;
      const scale = wrapW / W;
      canvas.style.width = wrapW + 'px';
      canvas.style.height = (H * scale) + 'px';
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    // â”€â”€â”€â”€â”€ Deck layout descriptions (ì¸µë³„ ì´ë¦„) â”€â”€â”€â”€â”€
    const deckInfo = {
      5: { name: '5ì¸µ - Passenger Cabins (ì¼ë°˜ ê°ì‹¤)', label: '5F Passenger Cabins / ì¼ë°˜ ê°ì‹¤' },
      6: { name: '6ì¸µ - Deluxe Cabins & Spa (ë””ëŸ­ìŠ¤ ê°ì‹¤ & ìŠ¤íŒŒ)', label: '6F Deluxe Cabins & Spa / ë””ëŸ­ìŠ¤ & ìŠ¤íŒŒ' },
      7: { name: '7ì¸µ - Restaurant & Lounge (ë ˆìŠ¤í† ë‘ & ë¼ìš´ì§€)', label: '7F Restaurant & Lounge / ë ˆìŠ¤í† ë‘ & ë¼ìš´ì§€' },
      8: { name: '8ì¸µ - Suite & Theater (ìŠ¤ìœ„íŠ¸ & ê·¹ì¥)', label: '8F Suite & Theater / ìŠ¤ìœ„íŠ¸ & ê·¹ì¥' },
      9: { name: '9ì¸µ - Pool & Sky Deck (í’€ & ìŠ¤ì¹´ì´ ë°í¬)', label: '9F Pool & Sky Deck / í’€ & ìŠ¤ì¹´ì´' }
    };

    // â”€â”€â”€â”€â”€ Build Ship Layout (grid-based) â”€â”€â”€â”€â”€
    function buildShipLayout() {
      // Initialize grid as walls
      grid = [];
      for (let r = 0; r < ROWS; r++) {
        grid[r] = [];
        for (let c = 0; c < COLS; c++) {
          grid[r][c] = 0; // wall by default
        }
      }

      corridors = [];
      cabins = [];
      doorways = [];
      restaurants = [];
      engineRooms = [];
      musterStations = [];
      stairways = [];
      exits = [];
      fireExtinguishers = [];

      // ì¸µë³„ ë ˆì´ì•„ì›ƒ ë¹Œë“œ
      switch (currentDeck) {
        case 5: buildDeck5(); break;
        case 6: buildDeck6(); break;
        case 7: buildDeck7(); break;
        case 8: buildDeck8(); break;
        case 9: buildDeck9(); break;
        default: buildDeck5();
      }

      // ì†Œí™”ê¸° ë°°ì¹˜ (ê³µí†µ)
      placeFireExtinguishers();
    }

    // â”€â”€ ê³µí†µ: ì†Œí™”ê¸° ë°°ì¹˜ â”€â”€
    function placeFireExtinguishers() {
      const fePositions = [];
      // ë³µë„ë§ˆë‹¤ ì¼ì • ê°„ê²©ìœ¼ë¡œ ì†Œí™”ê¸° ë°°ì¹˜
      for (const cor of corridors) {
        if (cor.w >= 10) { // ê¸´ ìˆ˜í‰ ë³µë„
          for (let x = cor.x + 4; x < cor.x + cor.w; x += 10) {
            fePositions.push({x: x, y: cor.y});
          }
        }
        if (cor.h >= 10) { // ê¸´ ìˆ˜ì§ ë³µë„
          for (let y = cor.y + 4; y < cor.y + cor.h; y += 10) {
            fePositions.push({x: cor.x, y: y});
          }
        }
      }
      // ê³„ë‹¨ ê·¼ì²˜
      for (const sw of stairways) {
        fePositions.push({x: sw.x + 1, y: sw.y - 1});
      }
      for (const pos of fePositions) {
        if (pos.y >= 0 && pos.y < ROWS && pos.x >= 0 && pos.x < COLS && isWalkable(pos.y, pos.x)) {
          fireExtinguishers.push({
            x: pos.x * CELL + CELL / 2,
            y: pos.y * CELL + CELL / 2,
            gx: pos.x, gy: pos.y,
            available: true
          });
        }
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 5ì¸µ - ì¼ë°˜ ê°ì‹¤ (Passenger Cabins)
    //   ì–‘ìª½ì— ê°ì‹¤ì´ ë°€ì§‘, ì¤‘ì•™ ê¸´ ë³µë„, í•˜ë‹¨ ê¸°ê´€ì‹¤
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function buildDeck5() {
      // Main horizontal corridors
      addCorridor(8, 10, 80, 2);
      addCorridor(8, 22, 80, 2);
      addCorridor(8, 34, 80, 2);

      // Vertical connectors
      addCorridor(15, 10, 2, 26);
      addCorridor(45, 10, 2, 26);
      addCorridor(70, 10, 2, 26);
      addCorridor(25, 10, 2, 14);
      addCorridor(55, 10, 2, 14);
      addCorridor(35, 22, 2, 14);
      addCorridor(60, 22, 2, 14);

      // Upper cabins (above corridor y=10)
      for (let x = 10; x < 80; x += 6) {
        if (!isStairwayZone5(x, 6) && !isMusterZone(x, 6))
          addCabin(x, 6, 4, 3, 9);
      }
      // Upper cabins (below corridor y=10)
      for (let x = 10; x < 80; x += 6) {
        if (!isStairwayZone5(x, 13) && !isMusterZone(x, 13))
          addCabin(x, 13, 4, 3, 12);
      }
      // Middle cabins
      for (let x = 10; x < 42; x += 6) addCabin(x, 18, 4, 3, 21);
      for (let x = 10; x < 42; x += 6) {
        if (!isStairwayZone5(x, 25)) addCabin(x, 25, 4, 3, 24);
      }
      for (let x = 62; x < 80; x += 6) addCabin(x, 18, 4, 3, 21);
      for (let x = 62; x < 80; x += 6) addCabin(x, 25, 4, 3, 24);

      // Lower cabins
      for (let x = 10; x < 80; x += 6) {
        if (!isStairwayZone5(x, 30) && x > 20 && x < 70) addCabin(x, 30, 4, 3, 33);
      }
      for (let x = 10; x < 80; x += 6) {
        if (!isStairwayZone5(x, 37) && x > 20 && x < 70) addCabin(x, 37, 4, 3, 36);
      }

      // Restaurant (ì¤‘ê°„ ë°í¬ ì¤‘ì•™)
      addRestaurant(44, 17, 16, 12);
      // Engine Room
      addEngineRoom(20, 41, 50, 6);
      // Muster Stations
      addMusterStation(6, 5, 6, 8);
      addMusterStation(78, 5, 8, 8);
      // Stairways
      addStairway(15, 12, 3, 3);
      addStairway(45, 12, 3, 3);
      addStairway(70, 12, 3, 3);
      addStairway(35, 24, 3, 3);
      addStairway(60, 24, 3, 3);
      // Exits
      addExit(6, 10, 2, 2); addCorridor(6, 10, 2, 2);
      addExit(6, 22, 2, 2); addCorridor(6, 22, 2, 2);
      addExit(85, 10, 2, 2); addCorridor(85, 10, 2, 2);
      addExit(85, 22, 2, 2); addCorridor(85, 22, 2, 2);
      addExit(6, 34, 2, 2); addCorridor(6, 34, 2, 2);
      addExit(85, 34, 2, 2); addCorridor(85, 34, 2, 2);
    }

    function isStairwayZone5(x, y) {
      const sz = [[15,12],[45,12],[70,12],[35,24],[60,24]];
      for (const s of sz) {
        if (x >= s[0]-1 && x <= s[0]+3 && y >= s[1]-1 && y <= s[1]+3) return true;
      }
      return false;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 6ì¸µ - ë””ëŸ­ìŠ¤ ê°ì‹¤ & ìŠ¤íŒŒ (Deluxe Cabins & Spa)
    //   ë” ë„“ì€ ê°ì‹¤(5ì¹¸), ì¤‘ì•™ì— ìŠ¤íŒŒ/ì‚¬ìš°ë‚˜, ì¢Œì¸¡ì— í”¼íŠ¸ë‹ˆìŠ¤
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function buildDeck6() {
      // Main corridor (ìƒë¶€)
      addCorridor(8, 12, 80, 2);
      // Middle corridor
      addCorridor(8, 26, 80, 2);
      // Vertical connectors
      addCorridor(20, 12, 2, 16);
      addCorridor(50, 12, 2, 16);
      addCorridor(75, 12, 2, 16);
      addCorridor(35, 12, 2, 16);

      // Deluxe cabins (ìœ„ ë³µë„ ìœ„ìª½, ë„“ì€ 5ì¹¸ ê°ì‹¤)
      for (let x = 10; x < 80; x += 7) {
        if (x < 18 || x > 22) // ê³„ë‹¨ ì œì™¸
          addCabin(x, 6, 5, 5, 11);
      }
      // Deluxe cabins (ìœ„ ë³µë„ ì•„ë˜ìª½)
      for (let x = 10; x < 34; x += 7) addCabin(x, 15, 5, 4, 14);
      for (let x = 56; x < 80; x += 7) addCabin(x, 15, 5, 4, 14);

      // Spa & Wellness Center (ì¤‘ì•™ í° ê³µê°„)
      addRestaurant(34, 15, 20, 10); // ìŠ¤íŒŒ (ë ˆìŠ¤í† ë‘ ë Œë”ë§ ì¬í™œìš©)

      // ì•„ë˜ ë³µë„ ì£¼ë³€ ê°ì‹¤
      for (let x = 10; x < 80; x += 7) {
        if (x < 33 || x > 55) // ìŠ¤íŒŒ ê³µê°„ ì œì™¸
          addCabin(x, 29, 5, 4, 28);
      }
      // í•˜ë‹¨ ê°ì‹¤ ì—´
      addCorridor(8, 38, 80, 2);
      addCorridor(20, 28, 2, 12);
      addCorridor(50, 28, 2, 12);
      addCorridor(75, 28, 2, 12);
      for (let x = 10; x < 80; x += 7) {
        if (x > 15 && x < 72) addCabin(x, 34, 5, 3, 33);
      }
      for (let x = 10; x < 80; x += 7) {
        if (x > 15 && x < 72) addCabin(x, 41, 5, 3, 40);
      }

      // Fitness Center (ì¢Œì¸¡ í•˜ë‹¨)
      addEngineRoom(6, 34, 12, 10); // í”¼íŠ¸ë‹ˆìŠ¤ (ì—”ì§„ë£¸ ë Œë”ë§ ì¬í™œìš©)

      // Stairways
      addStairway(18, 13, 3, 3);
      addStairway(50, 13, 3, 3);
      addStairway(75, 13, 3, 3);
      addStairway(35, 29, 3, 3);
      addStairway(62, 29, 3, 3);
      // Muster Station
      addMusterStation(6, 6, 5, 6);
      addMusterStation(80, 6, 6, 6);
      // Exits
      addExit(6, 12, 2, 2); addCorridor(6, 12, 2, 2);
      addExit(85, 12, 2, 2); addCorridor(85, 12, 2, 2);
      addExit(6, 26, 2, 2); addCorridor(6, 26, 2, 2);
      addExit(85, 26, 2, 2); addCorridor(85, 26, 2, 2);
      addExit(85, 38, 2, 2); addCorridor(85, 38, 2, 2);
      addExit(6, 38, 2, 2); addCorridor(6, 38, 2, 2);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 7ì¸µ - ë ˆìŠ¤í† ë‘ & ë¼ìš´ì§€ (Restaurant & Lounge)
    //   ëŒ€í˜• ë ˆìŠ¤í† ë‘ 2ê°œ, ë°”/ë¼ìš´ì§€, ê°ì‹¤ ì ìŒ
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function buildDeck7() {
      // Main corridor
      addCorridor(8, 14, 80, 2);
      addCorridor(8, 34, 80, 2);
      // Vertical connectors
      addCorridor(15, 14, 2, 22);
      addCorridor(42, 14, 2, 22);
      addCorridor(70, 14, 2, 22);
      addCorridor(55, 14, 2, 22);

      // ëŒ€í˜• ë ˆìŠ¤í† ë‘ (ì¢Œì¸¡)
      addRestaurant(8, 4, 32, 9);
      // ëŒ€í˜• ë ˆìŠ¤í† ë‘ (ìš°ì¸¡)
      addRestaurant(52, 4, 30, 9);

      // Bar & Lounge (ì¤‘ì•™ ìƒë‹¨)
      addRestaurant(42, 4, 8, 9);

      // ì¤‘ê°„ êµ¬ì—­ ê°ì‹¤
      for (let x = 10; x < 40; x += 7) addCabin(x, 17, 5, 4, 16);
      for (let x = 45; x < 80; x += 7) addCabin(x, 17, 5, 4, 16);

      // í•˜ë‹¨ ì˜ì—­: ë·”í˜ ë ˆìŠ¤í† ë‘
      addRestaurant(20, 22, 24, 10);

      // ì¹´í˜ (ìš°ì¸¡)
      addRestaurant(56, 22, 18, 10);

      // í•˜ë‹¨ ê°ì‹¤ë“¤
      for (let x = 10; x < 20; x += 6) addCabin(x, 22, 4, 4, 21);
      for (let x = 76; x < 86; x += 6) addCabin(x, 22, 4, 4, 21);
      for (let x = 10; x < 80; x += 6) {
        if (x > 17 && x < 68) addCabin(x, 37, 4, 3, 36);
      }
      for (let x = 10; x < 80; x += 6) {
        if (x > 17 && x < 68) addCabin(x, 41, 4, 3, 40);
      }
      addCorridor(8, 40, 80, 1);

      // Engine Room (í•˜ë‹¨ ì–‘ìª½ì— ì£¼ë°©)
      addEngineRoom(8, 44, 25, 4);
      addEngineRoom(60, 44, 25, 4);

      // Stairways
      addStairway(15, 16, 3, 3);
      addStairway(42, 16, 3, 3);
      addStairway(70, 16, 3, 3);
      addStairway(28, 35, 3, 3);
      addStairway(60, 35, 3, 3);
      // Muster
      addMusterStation(6, 10, 4, 4);
      addMusterStation(82, 10, 4, 4);
      // Exits
      addExit(6, 14, 2, 2); addCorridor(6, 14, 2, 2);
      addExit(85, 14, 2, 2); addCorridor(85, 14, 2, 2);
      addExit(6, 34, 2, 2); addCorridor(6, 34, 2, 2);
      addExit(85, 34, 2, 2); addCorridor(85, 34, 2, 2);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 8ì¸µ - ìŠ¤ìœ„íŠ¸ & ê·¹ì¥ (Suite & Theater)
    //   VIP ëŒ€í˜• ìŠ¤ìœ„íŠ¸ ê°ì‹¤, ì¤‘ì•™ ê·¹ì¥/ê³µì—°ì¥
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function buildDeck8() {
      // Main corridors
      addCorridor(8, 10, 80, 2);
      addCorridor(8, 28, 80, 2);
      // Vertical connectors
      addCorridor(18, 10, 2, 20);
      addCorridor(40, 10, 2, 20);
      addCorridor(65, 10, 2, 20);
      addCorridor(80, 10, 2, 20);

      // VIP Suite (ì¢Œì¸¡, ë§¤ìš° ë„“ì€ ê°ì‹¤ 8x5)
      for (let x = 10; x < 38; x += 10) addCabin(x, 4, 8, 5, 9);
      // VIP Suite (ìš°ì¸¡)
      for (let x = 44; x < 80; x += 10) addCabin(x, 4, 8, 5, 9);

      // Theater (ì¤‘ì•™ ëŒ€í˜• ê³µê°„)
      addRestaurant(22, 13, 24, 14);

      // ì†Œê·œëª¨ VIP ë¼ìš´ì§€ (ì¢Œì¸¡)
      addRestaurant(8, 13, 12, 8);
      // ì¹´ì§€ë…¸ (ìš°ì¸¡)
      addRestaurant(56, 13, 22, 8);

      // í•˜ë‹¨ ìŠ¤ìœ„íŠ¸
      for (let x = 8; x < 20; x += 8) addCabin(x, 22, 6, 5, 21);
      for (let x = 48; x < 80; x += 8) addCabin(x, 22, 6, 5, 21);

      // ìµœí•˜ë‹¨ ì¼ë°˜ ê°ì‹¤
      addCorridor(8, 38, 80, 2);
      addCorridor(25, 28, 2, 12);
      addCorridor(55, 28, 2, 12);
      for (let x = 10; x < 80; x += 7) {
        if (x > 20 && x < 75) addCabin(x, 31, 5, 4, 30);
      }
      for (let x = 10; x < 80; x += 7) {
        if (x > 20 && x < 75) addCabin(x, 41, 5, 4, 40);
      }

      // Engine area
      addEngineRoom(8, 43, 18, 4);
      addEngineRoom(68, 43, 18, 4);

      // Stairways
      addStairway(18, 11, 3, 3);
      addStairway(40, 11, 3, 3);
      addStairway(65, 11, 3, 3);
      addStairway(25, 29, 3, 3);
      addStairway(55, 29, 3, 3);
      // Muster
      addMusterStation(6, 4, 5, 6);
      addMusterStation(82, 4, 5, 6);
      // Exits
      addExit(6, 10, 2, 2); addCorridor(6, 10, 2, 2);
      addExit(85, 10, 2, 2); addCorridor(85, 10, 2, 2);
      addExit(6, 28, 2, 2); addCorridor(6, 28, 2, 2);
      addExit(85, 28, 2, 2); addCorridor(85, 28, 2, 2);
      addExit(6, 38, 2, 2); addCorridor(6, 38, 2, 2);
      addExit(85, 38, 2, 2); addCorridor(85, 38, 2, 2);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 9ì¸µ - í’€ & ìŠ¤ì¹´ì´ ë°í¬ (Pool & Sky Deck)
    //   ëŒ€í˜• ìˆ˜ì˜ì¥ 2ê°œ, ì„ ë°í¬, ì†Œìˆ˜ í”„ë¦¬ë¯¸ì—„ ê°ì‹¤
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function buildDeck9() {
      // Main corridor
      addCorridor(8, 16, 80, 2);
      addCorridor(8, 34, 80, 2);
      // Vertical
      addCorridor(15, 16, 2, 20);
      addCorridor(45, 16, 2, 20);
      addCorridor(75, 16, 2, 20);
      addCorridor(30, 16, 2, 20);
      addCorridor(60, 16, 2, 20);

      // ëŒ€í˜• ìˆ˜ì˜ì¥ (ì¢Œì¸¡ ìƒë‹¨)
      addRestaurant(8, 4, 28, 11);
      // ëŒ€í˜• ìˆ˜ì˜ì¥ (ìš°ì¸¡ ìƒë‹¨)
      addRestaurant(50, 4, 28, 11);

      // í’€ì‚¬ì´ë“œ ë°” (ì¤‘ì•™)
      addRestaurant(38, 4, 10, 11);

      // ì¤‘ê°„ í”„ë¦¬ë¯¸ì—„ ê°ì‹¤ (ìˆ˜ ì ìŒ, ë§¤ìš° ë„“ìŒ)
      for (let x = 10; x < 30; x += 12) addCabin(x, 19, 10, 5, 18);
      for (let x = 48; x < 78; x += 12) addCabin(x, 19, 10, 5, 18);
      // ì¤‘ì•™ ì„ ë°í¬/ë¼ìš´ì§€
      addRestaurant(32, 19, 14, 10);

      // í•˜ë‹¨ ì˜ì—­: ì„ ë² ë“œ ê³µê°„ (ì˜¤í”ˆ ë°í¬)
      addCorridor(8, 30, 80, 3); // ë„“ì€ ì˜¤í”ˆ ë°í¬ ë³µë„
      // ì†Œìˆ˜ ê°ì‹¤
      for (let x = 10; x < 40; x += 10) addCabin(x, 37, 8, 4, 36);
      for (let x = 50; x < 80; x += 10) addCabin(x, 37, 8, 4, 36);
      // í•˜ë‹¨ ë°”/ë ˆìŠ¤í† ë‘
      addRestaurant(20, 42, 18, 5);
      addRestaurant(52, 42, 18, 5);

      // Stairways
      addStairway(15, 17, 3, 3);
      addStairway(45, 17, 3, 3);
      addStairway(75, 17, 3, 3);
      addStairway(30, 35, 3, 3);
      addStairway(60, 35, 3, 3);
      // Muster
      addMusterStation(6, 12, 4, 4);
      addMusterStation(82, 12, 4, 4);
      // Exits
      addExit(6, 16, 2, 2); addCorridor(6, 16, 2, 2);
      addExit(85, 16, 2, 2); addCorridor(85, 16, 2, 2);
      addExit(6, 34, 2, 2); addCorridor(6, 34, 2, 2);
      addExit(85, 34, 2, 2); addCorridor(85, 34, 2, 2);
    }

    // ë™ì  ê³„ë‹¨/ì§‘ê²°ì§€ ì¶©ëŒ ê°ì§€ (ë°°ì¹˜ëœ stairways/musterStations ê¸°ì¤€)
    function isStairwayZone(x, y) {
      for (const sw of stairways) {
        if (x >= sw.x - 1 && x <= sw.x + sw.w && y >= sw.y - 1 && y <= sw.y + sw.h) return true;
      }
      return false;
    }

    function isMusterZone(x, y) {
      for (const ms of musterStations) {
        if (x >= ms.x - 1 && x <= ms.x + ms.w + 1 && y >= ms.y - 1 && y <= ms.y + ms.h + 1) return true;
      }
      return false;
    }

    function addCorridor(gx, gy, gw, gh) {
      corridors.push({ x: gx, y: gy, w: gw, h: gh });
      fillGrid(gx, gy, gw, gh, 1);
    }

    function addCabin(gx, gy, gw, gh, doorBridgeY) {
      cabins.push({ x: gx, y: gy, w: gw, h: gh, doorY: doorBridgeY });
      // ê°ì‹¤ ë‚´ë¶€ë¥¼ í†µí–‰ ê°€ëŠ¥(type 8)ìœ¼ë¡œ ì„¤ì •
      fillGrid(gx, gy, gw, gh, 8);
      // ì¶œì…êµ¬: ê°ì‹¤ ì¤‘ì•™ì—ì„œ ë³µë„ ë°©í–¥ìœ¼ë¡œ 1ì…€ ì—°ê²°
      if (doorBridgeY !== undefined) {
        const doorX = gx + Math.floor(gw / 2);
        if (doorBridgeY >= 0 && doorBridgeY < ROWS && doorX >= 0 && doorX < COLS) {
          grid[doorBridgeY][doorX] = 1; // ì¶œì…êµ¬ ì…€ì„ í†µí–‰ ê°€ëŠ¥ìœ¼ë¡œ
          doorways.push({ x: doorX, y: doorBridgeY, roomX: gx, roomY: gy });
        }
      }
    }

    function addRestaurant(gx, gy, gw, gh) {
      restaurants.push({ x: gx, y: gy, w: gw, h: gh });
      fillGrid(gx, gy, gw, gh, 3);
      // Make interior walkable
      fillGrid(gx + 1, gy + 1, gw - 2, gh - 2, 1);
      // ë ˆìŠ¤í† ë‘ ì¶œì…êµ¬ (ì¢Œì¸¡, ìš°ì¸¡, ë³µë„ ì—°ê²°)
      const doorPositions = [
        { x: gx, y: gy + Math.floor(gh / 2) },       // ì¢Œì¸¡ ì¶œì…êµ¬
        { x: gx + gw - 1, y: gy + Math.floor(gh / 2) }, // ìš°ì¸¡ ì¶œì…êµ¬
        { x: gx + Math.floor(gw / 3), y: gy },        // ìƒë‹¨ ì¶œì…êµ¬
        { x: gx + Math.floor(gw * 2 / 3), y: gy + gh - 1 }, // í•˜ë‹¨ ì¶œì…êµ¬
      ];
      for (const dp of doorPositions) {
        if (dp.y >= 0 && dp.y < ROWS && dp.x >= 0 && dp.x < COLS) {
          grid[dp.y][dp.x] = 1;
          doorways.push({ x: dp.x, y: dp.y, type: 'restaurant' });
        }
      }
    }

    function addEngineRoom(gx, gy, gw, gh) {
      engineRooms.push({ x: gx, y: gy, w: gw, h: gh });
      fillGrid(gx, gy, gw, gh, 4);
    }

    function addMusterStation(gx, gy, gw, gh) {
      musterStations.push({ x: gx, y: gy, w: gw, h: gh });
      fillGrid(gx, gy, gw, gh, 5);
    }

    function addStairway(gx, gy, gw, gh) {
      stairways.push({ x: gx, y: gy, w: gw, h: gh });
      fillGrid(gx, gy, gw, gh, 6);
    }

    function addExit(gx, gy, gw, gh) {
      exits.push({ x: gx, y: gy, w: gw, h: gh });
      fillGrid(gx, gy, gw, gh, 7);
    }

    function fillGrid(gx, gy, gw, gh, val) {
      for (let r = gy; r < gy + gh && r < ROWS; r++) {
        for (let c = gx; c < gx + gw && c < COLS; c++) {
          if (r >= 0 && c >= 0 && r < ROWS && c < COLS) {
            grid[r][c] = val;
          }
        }
      }
    }

    function isWalkable(gr, gc) {
      if (gr < 0 || gc < 0 || gr >= ROWS || gc >= COLS) return false;
      const v = grid[gr][gc];
      // 1=ë³µë„, 3=ë ˆìŠ¤í† ë‘, 5=ì§‘ê²°ì§€, 6=ê³„ë‹¨, 7=ì¶œêµ¬, 8=ê°ì‹¤ë‚´ë¶€
      return v === 1 || v === 3 || v === 5 || v === 6 || v === 7 || v === 8;
    }

    // â”€â”€â”€â”€â”€ Spawn Passengers â”€â”€â”€â”€â”€
    // â”€â”€â”€â”€â”€ Health-Aware Passenger Types (Eq. 20-22) â”€â”€â”€â”€â”€
    // Eq.20: ì´ë™ì„± ì§€ìˆ˜ Î¼_i âˆˆ [0,1] (0=immobile, 1=fully mobile)
    // Eq.21: ì†ë„ ì¡°ì • v_i = Î¼_i Â· v_base Â· f(age_i, condition_i)
    // Eq.22: ìš°ì„ ìˆœìœ„ P_i = Î±Â·(1-Î¼_i) + Î²Â·vulnerability_i + Î³Â·location_risk_i
    const PASSENGER_TYPES = {
      normal:     { label: 'ê±´ê°•í•œ ì„±ì¸', mu: [0.9, 1.0], fAge: 1.0,  color: '#4A90D9', ratio: 0.50 },
      elderly:    { label: 'ê³ ë ¹ì',      mu: [0.5, 0.8], fAge: 0.7,  color: '#F59E0B', ratio: 0.15 },
      child:      { label: 'ì–´ë¦°ì´',      mu: [0.6, 0.8], fAge: 0.8,  color: '#8B5CF6', ratio: 0.12 },
      wheelchair: { label: 'íœ ì²´ì–´',      mu: [0.2, 0.4], fAge: 0.5,  color: '#EC4899', ratio: 0.05 },
      pregnant:   { label: 'ì„ì‚°ë¶€',      mu: [0.5, 0.7], fAge: 0.75, color: '#14B8A6', ratio: 0.08 },
      injured:    { label: 'ë¶€ìƒì',      mu: [0.3, 0.6], fAge: 0.6,  color: '#EF4444', ratio: 0.10 }
    };

    function assignPassengerType() {
      const rand = Math.random();
      let cum = 0;
      for (const [k, t] of Object.entries(PASSENGER_TYPES)) {
        cum += t.ratio;
        if (rand < cum) return k;
      }
      return 'normal';
    }

    // â”€â”€â”€â”€â”€ Beer-Lambert Visibility Model (Eq. 10) â”€â”€â”€â”€â”€
    // V(C) = K / C, K=8 (ë°œê´‘ í‘œì§€íŒ), V<5m â†’ ì—°ê¸° ìœ„í—˜ êµ¬ì—­
    function calcVisibility(px, py) {
      let maxConc = 0;
      for (const f of fires) {
        const dx = px - f.x, dy = py - f.y;
        const dist = Math.sqrt(dx * dx + dy * dy);
        if (dist < f.smokeRadius) {
          const conc = 1 - dist / f.smokeRadius; // ì •ê·œí™”ëœ ë†ë„ [0,1]
          if (conc > maxConc) maxConc = conc;
        }
      }
      if (maxConc < 0.01) return 30; // ë§‘ì€ ê³µê¸° = 30m ê°€ì‹œê±°ë¦¬
      return Math.min(30, 8 / (maxConc * 10)); // K=8, ë†ë„ ìŠ¤ì¼€ì¼ë§
    }

    // â”€â”€â”€â”€â”€ Dynamic Risk Map (Eq. 11) â”€â”€â”€â”€â”€
    // R(x,y,t) = w1Â·F(x,y,t) + w2Â·S(x,y,t) + w3Â·D(x,y,t) + w4Â·C(x,y,t)
    let showRiskMap = false;
    const RISK_WEIGHTS = { wFire: 0.35, wSmoke: 0.30, wStruct: 0.20, wCrowd: 0.15 };

    function calcRiskAt(px, py) {
      let rFire = 0, rSmoke = 0, rStruct = 0, rCrowd = 0;
      // F(x,y,t): í™”ì› ê·¼ì ‘ë„ (1/dÂ² decay)
      for (const f of fires) {
        const dx = px - f.x, dy = py - f.y;
        const dist = Math.max(Math.sqrt(dx * dx + dy * dy), 1);
        if (dist < f.radius) rFire = Math.max(rFire, 1.0);
        else if (dist < f.radius * 3) rFire = Math.max(rFire, Math.min(1, (f.radius * f.radius) / (dist * dist)));
        // S(x,y,t): ì—°ê¸° ë†ë„
        if (dist < f.smokeRadius) rSmoke = Math.max(rSmoke, 1 - dist / f.smokeRadius);
      }
      // D(x,y,t): êµ¬ì¡°ì  ì†ìƒ (í™”ì¬ ì¥ê¸° ë…¸ì¶œ ê·¼ì‚¬)
      for (const f of fires) {
        const t = elapsedTime - f.startTime;
        const dx = px - f.x, dy = py - f.y;
        const dist = Math.sqrt(dx * dx + dy * dy);
        if (dist < f.radius * 2 && t > 10) rStruct = Math.max(rStruct, Math.min(1, t / 60 * (1 - dist / (f.radius * 2))));
      }
      // C(x,y,t): êµ°ì¤‘ ë°€ì§‘ë„ (Ï > 4ì¸/mÂ² â†’ ë‹µì•• ìœ„í—˜ ê¸‰ì¦)
      let nearby = 0;
      for (const p of passengers) {
        if (p.evacuated) continue;
        const dx = px - p.x, dy = py - p.y;
        if (Math.sqrt(dx * dx + dy * dy) < CELL * 4) nearby++;
      }
      rCrowd = Math.min(1, nearby / 12);
      return RISK_WEIGHTS.wFire * rFire + RISK_WEIGHTS.wSmoke * rSmoke +
             RISK_WEIGHTS.wStruct * rStruct + RISK_WEIGHTS.wCrowd * rCrowd;
    }

    function spawnPassengers() {
      passengers = [];
      const walkableCells = [];
      for (let r = 0; r < ROWS; r++) {
        for (let c = 0; c < COLS; c++) {
          if (isWalkable(r, c) && grid[r][c] !== 7) {
            walkableCells.push({ r, c });
          }
        }
      }

      for (let i = 0; i < passengerCount; i++) {
        const cell = walkableCells[Math.floor(Math.random() * walkableCells.length)];
        const typeKey = assignPassengerType();
        const typeInfo = PASSENGER_TYPES[typeKey];
        // Eq.20: Î¼_i
        const mu = typeInfo.mu[0] + Math.random() * (typeInfo.mu[1] - typeInfo.mu[0]);
        // Eq.21: v_i = Î¼_i Â· v_base Â· f(age, condition)
        const speedFactor = mu * typeInfo.fAge;
        const isSlow = speedFactor < 0.6;
        const px = cell.c * CELL + CELL / 2;
        const py = cell.r * CELL + CELL / 2;
        passengers.push({
          x: px,
          y: py,
          speed: speedFactor * (0.8 + Math.random() * 0.5),
          isSlow: isSlow,
          typeKey: typeKey,
          typeColor: typeInfo.color,
          mu: mu,
          evacuated: false,
          evacuatedTime: 0,
          path: [],
          pathTimer: 0,
          targetExit: null,
          opacity: 1,
          usingExtinguisher: false,
          extTarget: null,
          fireTarget: null,
          extPhase: null,
          extTimer: 0,
          stuckTimer: 0,
          lastX: px,
          lastY: py
        });
      }
    }

    // â”€â”€â”€â”€â”€ Fire Handling â”€â”€â”€â”€â”€
    function addFire(px, py) {
      fires.push({
        x: px,
        y: py,
        radius: 8,
        smokeRadius: 20,
        smokeOffX: 0, // Advection-Diffusion ë°”ëŒ ì´ë™ëŸ‰
        smokeOffY: 0,
        startTime: elapsedTime,
        pulsePhase: Math.random() * Math.PI * 2
      });
    }

    // Advection-Diffusion Smoke Transport (Eq. 5-7)
    // âˆ‚C/âˆ‚t + uÂ·âˆ‡C = DÂ·âˆ‡Â²C + S
    function updateFires(dt) {
      for (const f of fires) {
        const t = elapsedTime - f.startTime;
        f.radius = 8 + 0.6 * Math.pow(t, 1.3);
        f.smokeRadius = f.radius * 2.5 + 0.3 * t;
        // Cap maximums
        if (f.radius > 120) f.radius = 120;
        if (f.smokeRadius > 200) f.smokeRadius = 200;
        f.pulsePhase += dt * 4;
        // Wind advection: ë°”ëŒ ë°©í–¥ìœ¼ë¡œ ì—°ê¸° ì¤‘ì‹¬ ì´ë™ (Eq. 6)
        const advSpeed = WIND_SPEED * 15 * dt; // px/frame
        f.smokeOffX += Math.cos(WIND_DIR) * advSpeed;
        f.smokeOffY += Math.sin(WIND_DIR) * advSpeed;
        // ìµœëŒ€ ì´ë™ ë²”ìœ„ ì œí•œ (ì„ ì²´ ë‚´ë¶€)
        const maxOff = f.smokeRadius * 0.6;
        f.smokeOffX = Math.max(-maxOff, Math.min(maxOff, f.smokeOffX));
        f.smokeOffY = Math.max(-maxOff, Math.min(maxOff, f.smokeOffY));
      }
    }

    function isInFire(px, py) {
      for (const f of fires) {
        const dx = px - f.x, dy = py - f.y;
        if (Math.sqrt(dx * dx + dy * dy) < f.radius) return true;
      }
      return false;
    }

    function isInSmoke(px, py) {
      for (const f of fires) {
        // ë°”ëŒ offset ë°˜ì˜ëœ ì—°ê¸° ì¤‘ì‹¬ ê¸°ì¤€
        const smCx = f.x + (f.smokeOffX || 0);
        const smCy = f.y + (f.smokeOffY || 0);
        const dx = px - smCx, dy = py - smCy;
        if (Math.sqrt(dx * dx + dy * dy) < f.smokeRadius) return true;
      }
      return false;
    }

    function fireDangerAt(px, py) {
      let danger = 0;
      for (const f of fires) {
        const dx = px - f.x, dy = py - f.y;
        const dist = Math.sqrt(dx * dx + dy * dy);
        if (dist < f.radius) {
          danger += 8000; // í™”ì¬ ë‚´ë¶€ = ë†’ì€ ë¹„ìš©ì´ì§€ë§Œ í†µê³¼ ê°€ëŠ¥ (ìƒì¡´ íƒˆì¶œìš©)
        } else if (dist < f.radius * 1.5) {
          danger += 5000 * (1 - (dist - f.radius) / (f.radius * 0.5)); // í™”ì¬ ê·¼ì ‘ = ë§¤ìš° ë†’ì€ ë¹„ìš©
        } else if (dist < f.smokeRadius) {
          danger += 800 * (1 - dist / f.smokeRadius); // ì—°ê¸° êµ¬ì—­ = ë†’ì€ ë¹„ìš©
        } else if (dist < f.smokeRadius * 1.3) {
          danger += 200 * (1 - dist / (f.smokeRadius * 1.3)); // ì—°ê¸° ì™¸ê³½ = ì¤‘ê°„ ë¹„ìš©
        }
      }
      return danger;
    }

    // í™”ì¬ êµ¬ì—­ ë‚´ë¶€ì¸ì§€ í™•ì¸ (A* ê²½ë¡œì—ì„œ ì™„ì „ ì°¨ë‹¨ìš©)
    function isBlockedByFire(px, py) {
      for (const f of fires) {
        const dx = px - f.x, dy = py - f.y;
        if (Math.sqrt(dx * dx + dy * dy) < f.radius * 1.1) return true;
      }
      return false;
    }

    // â”€â”€â”€â”€â”€ A* Pathfinding â”€â”€â”€â”€â”€
    function findPath(startX, startY, targetExit) {
      const sr = Math.floor(startY / CELL);
      const sc = Math.floor(startX / CELL);
      const er = Math.floor((targetExit.y * CELL + targetExit.h * CELL / 2) / CELL);
      const ec = Math.floor((targetExit.x * CELL + targetExit.w * CELL / 2) / CELL);

      if (sr === er && sc === ec) return [];

      // Simple A*
      const open = [];
      const closed = new Set();
      const gScore = {};
      const fScore = {};
      const cameFrom = {};

      const key = (r, c) => r * COLS + c;
      const startKey = key(sr, sc);
      const endKey = key(er, ec);

      gScore[startKey] = 0;
      fScore[startKey] = heuristic(sr, sc, er, ec);
      open.push({ r: sr, c: sc, f: fScore[startKey] });

      const dirs = [
        [-1, 0], [1, 0], [0, -1], [0, 1],
        [-1, -1], [-1, 1], [1, -1], [1, 1]
      ];

      let iterations = 0;
      const maxIter = 20000;

      while (open.length > 0 && iterations < maxIter) {
        iterations++;
        // Find lowest fScore
        open.sort((a, b) => a.f - b.f);
        const current = open.shift();
        const ck = key(current.r, current.c);

        if (ck === endKey) {
          // Reconstruct path
          const path = [];
          let k = ck;
          while (k !== startKey) {
            const r = Math.floor(k / COLS);
            const c = k % COLS;
            path.unshift({ x: c * CELL + CELL / 2, y: r * CELL + CELL / 2 });
            k = cameFrom[k];
            if (k === undefined) break;
          }
          return path;
        }

        closed.add(ck);

        for (const [dr, dc] of dirs) {
          const nr = current.r + dr;
          const nc = current.c + dc;
          if (!isWalkable(nr, nc)) continue;

          const nk = key(nr, nc);
          if (closed.has(nk)) continue;

          // í™”ì¬ êµ¬ì—­ë„ ë†’ì€ ë¹„ìš©ìœ¼ë¡œ í†µê³¼ í—ˆìš© (ì™„ì „ ì°¨ë‹¨ X â†’ íƒˆì¶œ ë³´ì¥)
          const cellPx = nc * CELL + CELL / 2;
          const cellPy = nr * CELL + CELL / 2;

          // Diagonal check - avoid cutting corners
          if (dr !== 0 && dc !== 0) {
            if (!isWalkable(current.r + dr, current.c) || !isWalkable(current.r, current.c + dc)) continue;
          }

          const moveCost = (dr !== 0 && dc !== 0) ? 1.414 : 1;
          const dangerCost = fireDangerAt(cellPx, cellPy) * 0.5;
          const tentativeG = (gScore[ck] || 0) + moveCost + dangerCost;

          if (tentativeG < (gScore[nk] || Infinity)) {
            cameFrom[nk] = ck;
            gScore[nk] = tentativeG;
            fScore[nk] = tentativeG + heuristic(nr, nc, er, ec);
            if (!open.find(o => key(o.r, o.c) === nk)) {
              open.push({ r: nr, c: nc, f: fScore[nk] });
            }
          }
        }
      }

      return []; // no path found
    }

    function heuristic(r1, c1, r2, c2) {
      return Math.abs(r1 - r2) + Math.abs(c1 - c2);
    }

    function findNearestSafeExit(px, py) {
      let best = null;
      let bestScore = Infinity;
      // ì¶œêµ¬ + ê³„ë‹¨ ëª¨ë‘ ëŒ€í”¼ ëª©ì ì§€ë¡œ í¬í•¨ (ê³„ë‹¨ ë„ë‹¬ = ë‹¤ë¥¸ ì¸µ ì´ë™ = ëŒ€í”¼ ì™„ë£Œ)
      const allTargets = exits.concat(stairways);
      for (const ex of allTargets) {
        const ecx = ex.x * CELL + ex.w * CELL / 2;
        const ecy = ex.y * CELL + ex.h * CELL / 2;
        // í™”ì¬ ë‚´ë¶€ì˜ ì¶œêµ¬/ê³„ë‹¨ ì œì™¸
        if (isInFire(ecx, ecy)) continue;

        const dx = px - ecx, dy = py - ecy;
        const dist = Math.sqrt(dx * dx + dy * dy);

        // ìŠ¹ê°â†’ì¶œêµ¬ ê²½ë¡œìƒ í™”ì¬ê°€ ìˆëŠ”ì§€ í‰ê°€
        // ê²½ë¡œ ì¤‘ê°„ì ë“¤ì„ ìƒ˜í”Œë§í•˜ì—¬ í™”ì¬ ê·¼ì ‘ë„ ì²´í¬
        let pathFirePenalty = 0;
        const samples = 8;
        for (let i = 1; i <= samples; i++) {
          const t = i / (samples + 1);
          const sx = px + (ecx - px) * t;
          const sy = py + (ecy - py) * t;
          for (const f of fires) {
            const fdx = sx - f.x, fdy = sy - f.y;
            const fdist = Math.sqrt(fdx * fdx + fdy * fdy);
            if (fdist < f.radius * 1.5) {
              pathFirePenalty += 10000; // ê²½ë¡œìƒ í™”ì¬ â†’ í° íŒ¨ë„í‹°
            } else if (fdist < f.smokeRadius) {
              pathFirePenalty += 500 * (1 - fdist / f.smokeRadius);
            }
          }
        }

        // ì¶œêµ¬ ìì²´ì˜ í™”ì¬ ê·¼ì ‘ íŒ¨ë„í‹°
        let exitFirePenalty = 0;
        for (const f of fires) {
          const fdx = ecx - f.x, fdy = ecy - f.y;
          const fdist = Math.sqrt(fdx * fdx + fdy * fdy);
          if (fdist < f.smokeRadius) {
            exitFirePenalty += 2000 * (1 - fdist / f.smokeRadius);
          }
        }

        const score = dist + pathFirePenalty + exitFirePenalty;
        if (score < bestScore) {
          bestScore = score;
          best = ex;
        }
      }
      return best || exits[0];
    }

    // â”€â”€â”€â”€â”€ ì†Œí™”ê¸° ì‚¬ìš© ë¡œì§ â”€â”€â”€â”€â”€
    function findNearestExtinguisher(px, py, maxDist) {
      let best = null;
      let bestDist = maxDist || 80; // ìµœëŒ€ íƒìƒ‰ ê±°ë¦¬ (px)
      for (const fe of fireExtinguishers) {
        if (!fe.available) continue;
        const dx = px - fe.x, dy = py - fe.y;
        const dist = Math.sqrt(dx * dx + dy * dy);
        if (dist < bestDist) {
          bestDist = dist;
          best = fe;
        }
      }
      return best;
    }

    function useExtinguisher(fe, fireTarget) {
      fe.available = false;
      // ì†Œí™”ê¸° ì‚¬ìš© ì‹œ í™”ì¬ ë°˜ê²½ì„ ì¤„ì„ (ì™„ì „ ì§„í™”ëŠ” ì•„ë‹˜)
      fireTarget.radius = Math.max(fireTarget.radius * 0.4, 3);
      fireTarget.smokeRadius = Math.max(fireTarget.smokeRadius * 0.5, 8);
      // í™”ì¬ í™•ì‚° ì†ë„ ëŒ€í­ ê°ì†Œ (ì¬ë°œí™” ì‹œê°„ ë²Œê¸°)
      fireTarget.startTime = elapsedTime - 2;
    }

    function findNearestFireToPoint(px, py, maxDist) {
      let best = null;
      let bestDist = maxDist || 100;
      for (const f of fires) {
        const dx = px - f.x, dy = py - f.y;
        const dist = Math.sqrt(dx * dx + dy * dy);
        if (dist < bestDist) {
          bestDist = dist;
          best = f;
        }
      }
      return best;
    }

    // â”€â”€â”€â”€â”€ ê¸´ê¸‰ ì´ë™ (ê²½ë¡œë¥¼ ëª» ì°¾ì€ ìŠ¹ê°ìš©) â”€â”€â”€â”€â”€
    function emergencyMove(p, dt) {
      const gr = Math.floor(p.y / CELL);
      const gc = Math.floor(p.x / CELL);

      // 1) ì¶œêµ¬ ë°©í–¥ ë²¡í„° (ìµœìš°ì„ )
      let exitDx = 0, exitDy = 0;
      const safeExit = findNearestSafeExit(p.x, p.y);
      if (safeExit) {
        const ecx = safeExit.x * CELL + safeExit.w * CELL / 2;
        const ecy = safeExit.y * CELL + safeExit.h * CELL / 2;
        exitDx = ecx - p.x;
        exitDy = ecy - p.y;
        const d = Math.sqrt(exitDx * exitDx + exitDy * exitDy);
        if (d > 0) { exitDx /= d; exitDy /= d; }
      }

      // 2) í™”ì¬ íšŒí”¼ ë²¡í„°
      let awayDx = 0, awayDy = 0;
      for (const f of fires) {
        const fdx = p.x - f.x, fdy = p.y - f.y;
        const fdist = Math.sqrt(fdx * fdx + fdy * fdy);
        if (fdist > 0 && fdist < 250) {
          const weight = 1 / (fdist * fdist + 1);
          awayDx += (fdx / fdist) * weight;
          awayDy += (fdy / fdist) * weight;
        }
      }
      const awayLen = Math.sqrt(awayDx * awayDx + awayDy * awayDy);
      if (awayLen > 0) { awayDx /= awayLen; awayDy /= awayLen; }

      // 3) í•©ì„±: ì¶œêµ¬ ë°©í–¥ 70% + í™”ì¬ íšŒí”¼ 30%
      const combinedDx = exitDx * 0.7 + awayDx * 0.3;
      const combinedDy = exitDy * 0.7 + awayDy * 0.3;

      // 8ë°©í–¥ ì¤‘ í•©ì„± ë°©í–¥ìœ¼ë¡œ ê°€ì¥ ì˜ ë§ëŠ” ì´ë™ ê°€ëŠ¥í•œ ì…€ ì„ íƒ
      const dirs = [[-1,0],[1,0],[0,-1],[0,1],[-1,-1],[-1,1],[1,-1],[1,1]];
      let bestDir = null;
      let bestScore = -Infinity;

      for (const [dr, dc] of dirs) {
        const nr = gr + dr, nc = gc + dc;
        if (!isWalkable(nr, nc)) continue;
        const cellPx = nc * CELL + CELL / 2;
        const cellPy = nr * CELL + CELL / 2;
        // í™”ì¬ ë‚´ë¶€ë¼ë„ í†µê³¼ í—ˆìš© (ìƒì¡´ ìœ„í•´ íƒˆì¶œ ìš°ì„ )
        const firePenalty = isBlockedByFire(cellPx, cellPy) ? -0.5 : 0;
        // ëŒ€ê°ì„  ì½”ë„ˆ í†µê³¼ ë°©ì§€
        if (dr !== 0 && dc !== 0) {
          if (!isWalkable(gr + dr, gc) || !isWalkable(gr, gc + dc)) continue;
        }
        const score = dc * combinedDx + dr * combinedDy + firePenalty - fireDangerAt(cellPx, cellPy) * 0.0001;
        if (score > bestScore) {
          bestScore = score;
          bestDir = [dr, dc];
        }
      }

      if (bestDir) {
        const targetX = (gc + bestDir[1]) * CELL + CELL / 2;
        const targetY = (gr + bestDir[0]) * CELL + CELL / 2;
        const dx = targetX - p.x, dy = targetY - p.y;
        const dist = Math.sqrt(dx * dx + dy * dy);
        const speed = p.speed * CELL * 2 * 0.8; // ê¸´ê¸‰ ì´ë™ë„ ë¹ ë¥´ê²Œ
        if (dist > 1) {
          const newX = p.x + (dx / dist) * speed * dt;
          const newY = p.y + (dy / dist) * speed * dt;
          const chkR = Math.floor(newY / CELL), chkC = Math.floor(newX / CELL);
          if (isWalkable(chkR, chkC)) {
            p.x = newX;
            p.y = newY;
          }
        }
        return true;
      }
      return false;
    }

    // â”€â”€â”€â”€â”€ Update Passengers â”€â”€â”€â”€â”€
    function updatePassengers(dt) {
      let atRisk = 0;

      for (const p of passengers) {
        if (p.evacuated) continue;

        // Check if passenger is in fire zone -> ê¸´ê¸‰ íƒˆì¶œ (í™”ì¬ ë°˜ëŒ€ ë°©í–¥ìœ¼ë¡œ ê°•ì œ ì´ë™)
        if (isInFire(p.x, p.y)) {
          atRisk++;
          // í™”ì¬ ì•ˆì—ì„œë„ íƒˆì¶œ ì‹œë„ - í™”ì¬ ë°˜ëŒ€ ë°©í–¥ìœ¼ë¡œ ë¹ ë¥´ê²Œ ì´ë™
          const escapeSpeed = p.speed * CELL * 3; // 1.5ë°° ë¹ ë¥¸ ê¸´ê¸‰ ì†ë„
          let escapeDx = 0, escapeDy = 0;
          for (const f of fires) {
            const fdx = p.x - f.x, fdy = p.y - f.y;
            const fdist = Math.sqrt(fdx * fdx + fdy * fdy);
            if (fdist > 0 && fdist < f.radius * 2) {
              escapeDx += fdx / fdist;
              escapeDy += fdy / fdist;
            }
          }
          const elen = Math.sqrt(escapeDx * escapeDx + escapeDy * escapeDy);
          if (elen > 0) {
            p.x += (escapeDx / elen) * escapeSpeed * dt;
            p.y += (escapeDy / elen) * escapeSpeed * dt;
          }
          p.path = [];
          p.pathTimer = 0;
          continue;
        }

        if (isInSmoke(p.x, p.y)) {
          atRisk++;
        }

        if (mode !== 'evacuating') continue;

        // â˜… ë²½ ì•ˆì— ê°‡íŒ ìŠ¹ê° êµ¬ì¶œ: ê°€ì¥ ê°€ê¹Œìš´ walkable ì…€ë¡œ ìŠ¤ëƒ…
        const curR = Math.floor(p.y / CELL), curC = Math.floor(p.x / CELL);
        if (!isWalkable(curR, curC)) {
          let rescued = false;
          for (let sr = -2; sr <= 2 && !rescued; sr++) {
            for (let sc = -2; sc <= 2 && !rescued; sc++) {
              if (isWalkable(curR + sr, curC + sc)) {
                p.x = (curC + sc) * CELL + CELL / 2;
                p.y = (curR + sr) * CELL + CELL / 2;
                p.path = [];
                p.pathTimer = 0;
                rescued = true;
              }
            }
          }
        }

        // â˜… ë©ˆì¶¤ ê°ì§€: ì´ì „ í”„ë ˆì„ ëŒ€ë¹„ ì´ë™ ê±°ë¦¬ ì²´í¬
        const movedDx = p.x - p.lastX, movedDy = p.y - p.lastY;
        const movedDist = Math.sqrt(movedDx * movedDx + movedDy * movedDy);
        if (movedDist < 0.5) {
          p.stuckTimer += dt;
        } else {
          p.stuckTimer = 0;
        }
        p.lastX = p.x;
        p.lastY = p.y;

        // â˜… í™”ì¬ë¡œ ì°¨ë‹¨ëœ ê²½ë¡œ í¬ì¸íŠ¸ë¥¼ ê±´ë„ˆë›°ê¸° (ì „ì²´ ì¬íƒìƒ‰ ëŒ€ì‹ )
        while (p.path.length > 0 && isBlockedByFire(p.path[0].x, p.path[0].y)) {
          p.path.shift();
        }

        // ê²½ë¡œ ì¬ê³„ì‚° ì¡°ê±´
        p.pathTimer -= dt;
        const needsRepath = p.path.length === 0 || p.pathTimer <= 0;
        // ë©ˆì¶°ìˆìœ¼ë©´ ë” ìì£¼ ì¬íƒìƒ‰ (1ì´ˆë¡œ ë‹¨ì¶•)
        const isStuck = p.stuckTimer > 1;
        const shouldRepath = needsRepath || (isStuck && p.pathTimer <= 0.2);

        if (shouldRepath) {
          // ë©ˆì¶°ìˆì„ ë•Œ: ëª¨ë“  ì¶œêµ¬ ì‹œë„ (ê°€ì¥ ì•ˆì „í•œ ê²ƒë¶€í„°)
          if (isStuck) {
            p.targetExit = findNearestSafeExit(p.x, p.y);
            p.path = findPath(p.x, p.y, p.targetExit);

            // ì²« ë²ˆì§¸ ì¶œêµ¬ë¡œ ê²½ë¡œ ëª» ì°¾ìœ¼ë©´ ë‹¤ë¥¸ ì¶œêµ¬/ê³„ë‹¨ë„ ì‹œë„
            if (p.path.length === 0) {
              const allTargets = exits.concat(stairways);
              for (const ex of allTargets) {
                if (ex === p.targetExit) continue;
                const altPath = findPath(p.x, p.y, ex);
                if (altPath.length > 0) {
                  p.path = altPath;
                  p.targetExit = ex;
                  break;
                }
              }
            }
          } else {
            p.targetExit = findNearestSafeExit(p.x, p.y);
            p.path = findPath(p.x, p.y, p.targetExit);
          }
          p.pathTimer = 1.0 + Math.random() * 1.5;

          // â˜… ê²½ë¡œë¥¼ ì°¾ì§€ ëª»í•œ ê²½ìš° = í™”ì¬ë¡œ ì°¨ë‹¨ë¨ â†’ ì†Œí™”ê¸° ì‚¬ìš© ì‹œë„ ë˜ëŠ” ê¸´ê¸‰ ì´ë™
          if (p.path.length === 0 && !p.usingExtinguisher) {
            const nearFire = findNearestFireToPoint(p.x, p.y, 120);
            if (nearFire) {
              const fe = findNearestExtinguisher(p.x, p.y, 150);
              if (fe) {
                p.usingExtinguisher = true;
                p.extTarget = fe;
                p.fireTarget = nearFire;
                p.extPhase = 'goToFE';
                p.extTimer = 0;
              } else {
                // ì†Œí™”ê¸° ì—†ìœ¼ë©´ ì¦‰ì‹œ ê¸´ê¸‰ ì´ë™
                emergencyMove(p, dt);
              }
            } else {
              // í™”ì¬ê°€ ë©€ë©´ ê°€ì¥ ê°€ê¹Œìš´ ì¶œêµ¬ë¡œ ì§ì„  ì´ë™
              emergencyMove(p, dt);
            }
          }
        }

        // â˜… ì†Œí™”ê¸° ì‚¬ìš© ì¤‘ì¸ ìŠ¹ê° ì²˜ë¦¬
        if (p.usingExtinguisher) {
          const speed = p.speed * CELL * 2 * 0.8;
          if (p.extPhase === 'goToFE') {
            const dx = p.extTarget.x - p.x, dy = p.extTarget.y - p.y;
            const dist = Math.sqrt(dx * dx + dy * dy);
            if (dist < 8) {
              p.extPhase = 'goToFire';
            } else {
              p.x += (dx / dist) * speed * dt;
              p.y += (dy / dist) * speed * dt;
            }
            continue;
          }
          if (p.extPhase === 'goToFire') {
            const dx = p.fireTarget.x - p.x, dy = p.fireTarget.y - p.y;
            const dist = Math.sqrt(dx * dx + dy * dy);
            const targetDist = p.fireTarget.radius + 10;
            if (dist < targetDist + 5) {
              p.extPhase = 'extinguish';
              p.extTimer = 0;
            } else {
              p.x += (dx / dist) * speed * dt;
              p.y += (dy / dist) * speed * dt;
            }
            continue;
          }
          if (p.extPhase === 'extinguish') {
            p.extTimer += dt;
            if (p.extTimer >= 3) {
              useExtinguisher(p.extTarget, p.fireTarget);
              p.usingExtinguisher = false;
              p.path = [];
              p.pathTimer = 0;
              p.stuckTimer = 0;
            }
            continue;
          }
        }

        // â˜… ê²½ë¡œê°€ ìˆìœ¼ë©´ ë”°ë¼ ì´ë™
        if (p.path.length > 0) {
          const target = p.path[0];
          const dx = target.x - p.x;
          const dy = target.y - p.y;
          const dist = Math.sqrt(dx * dx + dy * dy);

          let speed = p.speed * CELL * 2;
          // Beer-Lambert visibility-based speed reduction (Eq. 10)
          if (isInSmoke(p.x, p.y)) {
            const vis = calcVisibility(p.x, p.y);
            // ê°€ì‹œì„± 30m(ë§‘ìŒ)â†’1.0, 5m(ì €ì‹œì•¼)â†’0.3, 1m(ê·¹ì €)â†’0.1
            const visFactor = Math.max(0.1, Math.min(1.0, vis / 30));
            speed *= visFactor;
          }

          // Social Force Model (Eq. 1): F_i = F_desire + Î£ F_social + Î£ F_wall + F_random
          // Crowd density (Greenshields Eq. 4) + Social repulsion
          let nearby = 0;
          let socialFx = 0, socialFy = 0; // ì‚¬íšŒì  ë°˜ë°œë ¥
          for (const other of passengers) {
            if (other === p || other.evacuated) continue;
            const odx = other.x - p.x, ody = other.y - p.y;
            const oDist = Math.sqrt(odx * odx + ody * ody);
            if (oDist < CELL * 3) {
              nearby++;
              // Social repulsion force: ê°€ê¹Œìš¸ìˆ˜ë¡ ê°•í•œ ë°˜ë°œ (AÂ·exp(-d/B))
              if (oDist > 0.5) {
                const A = 2.0, B = CELL * 1.5;
                const repulsion = A * Math.exp(-oDist / B);
                socialFx -= (odx / oDist) * repulsion;
                socialFy -= (ody / oDist) * repulsion;
              }
            }
          }
          if (nearby > 0) {
            speed *= Math.pow(1 - Math.min(nearby / 8, 0.8), 1.4);
          }

          const moveAmt = speed * dt;
          // ì´ë™ ë°©í–¥ = ê²½ë¡œ ë°©í–¥(desire) + Social Force ë³´ì •
          let moveDx = (dx / dist);
          let moveDy = (dy / dist);
          // Social force blending (ì•½í•œ ë³´ì •, ì£¼ ë°©í–¥ ìœ ì§€)
          const sfScale = 0.15;
          moveDx += socialFx * sfScale;
          moveDy += socialFy * sfScale;
          // ì •ê·œí™”
          const moveMag = Math.sqrt(moveDx * moveDx + moveDy * moveDy);
          if (moveMag > 0) { moveDx /= moveMag; moveDy /= moveMag; }

          if (dist < moveAmt) {
            p.x = target.x;
            p.y = target.y;
            p.path.shift();
          } else {
            const newX = p.x + moveDx * moveAmt;
            const newY = p.y + moveDy * moveAmt;
            // â˜… ë²½ ì§„ì… ë°©ì§€: ì´ë™ í›„ ìœ„ì¹˜ê°€ walkableì¸ì§€ ê²€ì¦
            const newR = Math.floor(newY / CELL), newC = Math.floor(newX / CELL);
            if (isWalkable(newR, newC)) {
              p.x = newX;
              p.y = newY;
            } else {
              // Social Forceê°€ ë²½ìœ¼ë¡œ ë°€ì—ˆìœ¼ë©´ ê²½ë¡œ ë°©í–¥ë§Œìœ¼ë¡œ ì´ë™
              const fallbackX = p.x + (dx / dist) * moveAmt;
              const fallbackY = p.y + (dy / dist) * moveAmt;
              const fbR = Math.floor(fallbackY / CELL), fbC = Math.floor(fallbackX / CELL);
              if (isWalkable(fbR, fbC)) {
                p.x = fallbackX;
                p.y = fallbackY;
              }
            }
          }
        }
        // â˜… ê²½ë¡œ ì—†ê³  0.5ì´ˆ ì´ìƒ ë©ˆì¶¤ â†’ ê¸´ê¸‰ ì´ë™ (ì¶œêµ¬ ë°©í–¥ ìš°ì„ )
        else if (p.stuckTimer > 0.5) {
          emergencyMove(p, dt);
        }

        // â˜… ì¥ê¸° ë©ˆì¶¤ êµ¬ì¶œ (15ì´ˆ ì´ìƒ): ê°€ì¥ ê°€ê¹Œìš´ ì¶œêµ¬/ê³„ë‹¨ìœ¼ë¡œ ê°•ì œ ì´ë™
        if (p.stuckTimer > 15 && !p.usingExtinguisher) {
          const allTargets = exits.concat(stairways);
          let nearest = null, nearDist = Infinity;
          for (const ex of allTargets) {
            const ecx = ex.x * CELL + ex.w * CELL / 2;
            const ecy = ex.y * CELL + ex.h * CELL / 2;
            const d = Math.sqrt((p.x - ecx) ** 2 + (p.y - ecy) ** 2);
            if (d < nearDist) { nearDist = d; nearest = ex; }
          }
          if (nearest) {
            // ì¶œêµ¬ ë°©í–¥ìœ¼ë¡œ ë¹ ë¥´ê²Œ ì§ì„  ì´ë™ (ë²½ ë¬´ì‹œ)
            const ecx = nearest.x * CELL + nearest.w * CELL / 2;
            const ecy = nearest.y * CELL + nearest.h * CELL / 2;
            const fdx = ecx - p.x, fdy = ecy - p.y;
            const fd = Math.sqrt(fdx * fdx + fdy * fdy);
            if (fd > 1) {
              const forceSpeed = p.speed * CELL * 4;
              p.x += (fdx / fd) * forceSpeed * dt;
              p.y += (fdy / fd) * forceSpeed * dt;
            }
          }
        }

        // Check if reached exit or stairway (ê³„ë‹¨ ë„ë‹¬ = ë‹¤ë¥¸ ì¸µ ì´ë™ = ëŒ€í”¼ ì™„ë£Œ)
        const allEvacTargets = exits.concat(stairways);
        for (const ex of allEvacTargets) {
          const ecx = ex.x * CELL + ex.w * CELL / 2;
          const ecy = ex.y * CELL + ex.h * CELL / 2;
          const dx = p.x - ecx, dy = p.y - ecy;
          if (Math.sqrt(dx * dx + dy * dy) < CELL * 2) {
            p.evacuated = true;
            p.evacuatedTime = elapsedTime;
            evacuatedCount++;
            evacuationTimes.push(elapsedTime);
            break;
          }
        }
      }

      return atRisk;
    }

    // â”€â”€â”€â”€â”€ Drawing â”€â”€â”€â”€â”€
    function drawShip() {
      // Ship hull outline
      ctx.fillStyle = '#111a25';
      ctx.fillRect(0, 0, W, H);

      // Ship hull shape
      ctx.beginPath();
      ctx.moveTo(40, H - 15);
      ctx.quadraticCurveTo(10, H - 40, 30, 30);
      ctx.lineTo(60, 15);
      ctx.lineTo(W - 60, 15);
      ctx.lineTo(W - 30, 30);
      ctx.quadraticCurveTo(W - 10, H - 40, W - 40, H - 15);
      ctx.closePath();
      ctx.fillStyle = '#152232';
      ctx.fill();
      ctx.strokeStyle = '#2a4060';
      ctx.lineWidth = 2;
      ctx.stroke();

      // Engine rooms / Utility areas
      const erLabels = {
        5: 'ENGINE ROOM / ê¸°ê´€ì‹¤',
        6: 'FITNESS CENTER / í”¼íŠ¸ë‹ˆìŠ¤',
        7: 'KITCHEN / ì£¼ë°©',
        8: 'UTILITY / ì¥ë¹„ì‹¤',
        9: 'MAINTENANCE / ê´€ë¦¬ì‹¤'
      };
      const erLabel = erLabels[currentDeck] || 'ENGINE ROOM';
      for (const er of engineRooms) {
        ctx.fillStyle = 'rgba(128, 90, 213, 0.12)';
        ctx.fillRect(er.x * CELL, er.y * CELL, er.w * CELL, er.h * CELL);
        ctx.strokeStyle = 'rgba(128, 90, 213, 0.4)';
        ctx.lineWidth = 1;
        ctx.strokeRect(er.x * CELL, er.y * CELL, er.w * CELL, er.h * CELL);
        ctx.fillStyle = 'rgba(128, 90, 213, 0.6)';
        ctx.font = '10px sans-serif';
        ctx.fillText(erLabel, er.x * CELL + 6, er.y * CELL + 14);
      }

      // Cabins (ê°ì‹¤)
      for (const cab of cabins) {
        ctx.fillStyle = '#2D3A4A';
        ctx.fillRect(cab.x * CELL, cab.y * CELL, cab.w * CELL, cab.h * CELL);
        ctx.strokeStyle = '#4A5C6E';
        ctx.lineWidth = 0.8;
        ctx.strokeRect(cab.x * CELL, cab.y * CELL, cab.w * CELL, cab.h * CELL);
      }

      // ì¶œì…êµ¬ (Doorways) - ë°ì€ ë…¸ë€ìƒ‰ í‘œì‹œ
      for (const dw of doorways) {
        const dx = dw.x * CELL;
        const dy = dw.y * CELL;
        // ì¶œì…êµ¬ ë°°ê²½
        ctx.fillStyle = 'rgba(236, 201, 75, 0.6)';
        ctx.fillRect(dx + 1, dy + 1, CELL - 2, CELL - 2);
        // ì¶œì…êµ¬ í…Œë‘ë¦¬
        ctx.strokeStyle = 'rgba(236, 201, 75, 0.9)';
        ctx.lineWidth = 1;
        ctx.strokeRect(dx + 1, dy + 1, CELL - 2, CELL - 2);
      }

      // ì†Œí™”ê¸° (Fire Extinguishers) - ë¹¨ê°„ ì‚¬ê°í˜• + FE í‘œì‹œ
      for (const fe of fireExtinguishers) {
        const fex = fe.x - 4;
        const fey = fe.y - 4;
        if (fe.available) {
          // ì‚¬ìš© ê°€ëŠ¥: ë¹¨ê°„ ì‚¬ê°í˜•
          ctx.fillStyle = 'rgba(220, 38, 38, 0.8)';
          ctx.fillRect(fex, fey, 8, 8);
          ctx.strokeStyle = '#FCA5A5';
          ctx.lineWidth = 0.5;
          ctx.strokeRect(fex, fey, 8, 8);
          // ì‹­ì í‘œì‹œ (ì†Œí™”ê¸° ì‹¬ë³¼)
          ctx.strokeStyle = '#FFFFFF';
          ctx.lineWidth = 1;
          ctx.beginPath();
          ctx.moveTo(fe.x, fey + 1);
          ctx.lineTo(fe.x, fey + 7);
          ctx.moveTo(fex + 1, fe.y);
          ctx.lineTo(fex + 7, fe.y);
          ctx.stroke();
        } else {
          // ì‚¬ìš©ë¨: íšŒìƒ‰
          ctx.fillStyle = 'rgba(100, 116, 139, 0.4)';
          ctx.fillRect(fex, fey, 8, 8);
        }
      }

      // Restaurant / ê³µìš© ê³µê°„
      const facilityNames = {
        5: ['RESTAURANT / ë ˆìŠ¤í† ë‘'],
        6: ['SPA & WELLNESS / ìŠ¤íŒŒ', 'FITNESS / í”¼íŠ¸ë‹ˆìŠ¤'],
        7: ['MAIN DINING / ë©”ì¸ ë‹¤ì´ë‹', 'BUFFET / ë·”í˜', 'BAR & LOUNGE / ë°”', 'CAFE / ì¹´í˜'],
        8: ['THEATER / ê·¹ì¥', 'VIP LOUNGE / VIP ë¼ìš´ì§€', 'CASINO / ì¹´ì§€ë…¸'],
        9: ['POOL / ìˆ˜ì˜ì¥', 'POOL / ìˆ˜ì˜ì¥', 'POOLSIDE BAR / í’€ë°”', 'SUN DECK LOUNGE / ì„ ë°í¬', 'SKY BAR / ìŠ¤ì¹´ì´ë°”', 'SKY BAR / ìŠ¤ì¹´ì´ë°”']
      };
      const names = facilityNames[currentDeck] || ['FACILITY'];
      for (let ri = 0; ri < restaurants.length; ri++) {
        const rest = restaurants[ri];
        ctx.fillStyle = 'rgba(237, 137, 54, 0.08)';
        ctx.fillRect(rest.x * CELL, rest.y * CELL, rest.w * CELL, rest.h * CELL);
        ctx.strokeStyle = 'rgba(237, 137, 54, 0.4)';
        ctx.lineWidth = 1;
        ctx.strokeRect(rest.x * CELL, rest.y * CELL, rest.w * CELL, rest.h * CELL);
        ctx.fillStyle = 'rgba(237, 137, 54, 0.6)';
        ctx.font = '10px sans-serif';
        ctx.fillText(names[ri] || names[0], rest.x * CELL + 6, rest.y * CELL + 14);
      }

      // Corridors
      for (const cor of corridors) {
        ctx.fillStyle = '#3a4858';
        ctx.fillRect(cor.x * CELL, cor.y * CELL, cor.w * CELL, cor.h * CELL);
      }

      // Muster stations
      for (const ms of musterStations) {
        ctx.fillStyle = 'rgba(56, 161, 105, 0.15)';
        ctx.fillRect(ms.x * CELL, ms.y * CELL, ms.w * CELL, ms.h * CELL);
        ctx.strokeStyle = 'rgba(56, 161, 105, 0.5)';
        ctx.lineWidth = 1.5;
        ctx.setLineDash([4, 3]);
        ctx.strokeRect(ms.x * CELL, ms.y * CELL, ms.w * CELL, ms.h * CELL);
        ctx.setLineDash([]);
        ctx.fillStyle = 'rgba(56, 161, 105, 0.7)';
        ctx.font = 'bold 9px sans-serif';
        ctx.fillText('MUSTER', ms.x * CELL + 4, ms.y * CELL + 14);
        ctx.fillText('ì§‘ê²°ì§€', ms.x * CELL + 4, ms.y * CELL + 26);
      }

      // Stairways (ê³„ë‹¨ = ëŒ€í”¼ ê°€ëŠ¥ ì§€ì , ë‹¤ë¥¸ ì¸µ ì´ë™)
      for (const sw of stairways) {
        ctx.fillStyle = 'rgba(49, 130, 206, 0.25)';
        ctx.fillRect(sw.x * CELL, sw.y * CELL, sw.w * CELL, sw.h * CELL);
        ctx.strokeStyle = 'rgba(49, 130, 206, 0.8)';
        ctx.lineWidth = 1.5;
        ctx.strokeRect(sw.x * CELL, sw.y * CELL, sw.w * CELL, sw.h * CELL);
        // Draw stair lines
        const sx = sw.x * CELL, sy = sw.y * CELL;
        const swidth = sw.w * CELL, sheight = sw.h * CELL;
        ctx.strokeStyle = 'rgba(49, 130, 206, 0.5)';
        ctx.lineWidth = 0.5;
        for (let i = 1; i < 4; i++) {
          ctx.beginPath();
          ctx.moveTo(sx, sy + (sheight / 4) * i);
          ctx.lineTo(sx + swidth, sy + (sheight / 4) * i);
          ctx.stroke();
        }
        // Stairway label
        ctx.fillStyle = 'rgba(49, 130, 206, 0.9)';
        ctx.font = 'bold 6px sans-serif';
        ctx.fillText('STAIR', sx + 2, sy + sheight - 3);
      }

      // Exits
      for (const ex of exits) {
        ctx.fillStyle = '#38A169';
        ctx.fillRect(ex.x * CELL, ex.y * CELL, ex.w * CELL, ex.h * CELL);
        // Glow
        ctx.shadowColor = '#38A169';
        ctx.shadowBlur = 8;
        ctx.fillRect(ex.x * CELL, ex.y * CELL, ex.w * CELL, ex.h * CELL);
        ctx.shadowBlur = 0;
        // Label
        ctx.fillStyle = '#fff';
        ctx.font = 'bold 7px sans-serif';
        ctx.fillText('EXIT', ex.x * CELL + 1, ex.y * CELL + 12);
      }

      // Deck label (í˜„ì¬ ì„ íƒëœ ì¸µ)
      ctx.fillStyle = 'rgba(160, 174, 192, 0.5)';
      ctx.font = 'bold 13px sans-serif';
      const info = deckInfo[currentDeck];
      if (info) {
        ctx.fillText(info.label, 90, 28);
      }
    }

    function drawFires() {
      for (let i = 0; i < fires.length; i++) {
        const f = fires[i];
        const fireNum = i + 1;

        // Smoke (outer) â€” Advection-Diffusion wind offset (Eq. 5-7)
        const smCx = f.x + (f.smokeOffX || 0);
        const smCy = f.y + (f.smokeOffY || 0);
        const smokeGrad = ctx.createRadialGradient(smCx, smCy, f.radius, smCx, smCy, f.smokeRadius);
        smokeGrad.addColorStop(0, 'rgba(100, 100, 100, 0.25)');
        smokeGrad.addColorStop(0.5, 'rgba(80, 80, 80, 0.12)');
        smokeGrad.addColorStop(1, 'rgba(60, 60, 60, 0)');
        ctx.fillStyle = smokeGrad;
        ctx.beginPath();
        // ë°”ëŒ ë°©í–¥ìœ¼ë¡œ íƒ€ì› ë¹„ìœ¨ ë³€í™” (í’í•˜ë°©í–¥ ë” ë„“ê²Œ)
        const windStretch = 1.3 + WIND_SPEED * 0.5;
        ctx.ellipse(smCx, smCy, f.smokeRadius * windStretch, f.smokeRadius, WIND_DIR, 0, Math.PI * 2);
        ctx.fill();

        // Fire (inner)
        const pulse = 1 + 0.15 * Math.sin(f.pulsePhase);
        const drawRadius = f.radius * pulse;
        const fireGrad = ctx.createRadialGradient(f.x, f.y, 0, f.x, f.y, drawRadius);
        fireGrad.addColorStop(0, 'rgba(255, 255, 100, 0.9)');
        fireGrad.addColorStop(0.3, 'rgba(255, 120, 20, 0.7)');
        fireGrad.addColorStop(0.7, 'rgba(229, 62, 62, 0.4)');
        fireGrad.addColorStop(1, 'rgba(229, 62, 62, 0)');
        ctx.fillStyle = fireGrad;
        ctx.beginPath();
        ctx.arc(f.x, f.y, drawRadius, 0, Math.PI * 2);
        ctx.fill();

        // Fire ë²ˆí˜¸ ë¼ë²¨ (ìƒë‹¨ ë°°ì§€)
        const label = 'FIRE #' + fireNum;
        ctx.font = 'bold 9px sans-serif';
        ctx.textAlign = 'center';
        const labelY = f.y - drawRadius - 8;
        // ë°°ì§€ ë°°ê²½ (roundRect í˜¸í™˜)
        const labelW = ctx.measureText(label).width + 10;
        const bx = f.x - labelW / 2, by = labelY - 9, bw = labelW, bh = 14, br = 4;
        ctx.fillStyle = 'rgba(220, 38, 38, 0.9)';
        ctx.beginPath();
        ctx.moveTo(bx + br, by);
        ctx.lineTo(bx + bw - br, by);
        ctx.quadraticCurveTo(bx + bw, by, bx + bw, by + br);
        ctx.lineTo(bx + bw, by + bh - br);
        ctx.quadraticCurveTo(bx + bw, by + bh, bx + bw - br, by + bh);
        ctx.lineTo(bx + br, by + bh);
        ctx.quadraticCurveTo(bx, by + bh, bx, by + bh - br);
        ctx.lineTo(bx, by + br);
        ctx.quadraticCurveTo(bx, by, bx + br, by);
        ctx.closePath();
        ctx.fill();
        // ë°°ì§€ í…ìŠ¤íŠ¸
        ctx.fillStyle = '#FFFFFF';
        ctx.fillText(label, f.x, labelY);
        ctx.textAlign = 'start';
      }
    }

    // â”€â”€â”€â”€â”€ Risk Map Overlay (Eq. 11) â”€â”€â”€â”€â”€
    function drawRiskMapOverlay() {
      if (!showRiskMap || fires.length === 0) return;
      const step = 10; // 10px grid for performance
      for (let px = 0; px < W; px += step) {
        for (let py = 0; py < H; py += step) {
          const c = Math.floor(px / CELL), r = Math.floor(py / CELL);
          if (c < 0 || c >= COLS || r < 0 || r >= ROWS) continue;
          if (grid[r][c] === 0) continue; // skip walls
          const risk = calcRiskAt(px, py);
          if (risk < 0.05) continue;
          // Heatmap: green(safe) â†’ yellow â†’ red(danger)
          let red, green, blue;
          if (risk < 0.5) {
            red = Math.floor(255 * risk * 2);
            green = 255;
            blue = 0;
          } else {
            red = 255;
            green = Math.floor(255 * (1 - risk) * 2);
            blue = 0;
          }
          ctx.fillStyle = 'rgba(' + red + ',' + green + ',' + blue + ',' + (risk * 0.35) + ')';
          ctx.fillRect(px, py, step, step);
        }
      }
      // Risk map label
      ctx.fillStyle = 'rgba(124, 58, 237, 0.8)';
      ctx.font = 'bold 10px sans-serif';
      ctx.fillText('RISK MAP ON', W - 95, 18);
    }

    function drawPassengers() {
      for (const p of passengers) {
        if (p.evacuated) continue;

        const radius = 4;

        // Draw path (faint) - ìŠ¹ê° ìœ í˜•ë³„ ìƒ‰ìƒ ì ìš©
        if (p.path.length > 0 && mode === 'evacuating') {
          ctx.beginPath();
          ctx.moveTo(p.x, p.y);
          for (let i = 0; i < Math.min(p.path.length, 8); i++) {
            ctx.lineTo(p.path[i].x, p.path[i].y);
          }
          const pathColor = p.typeColor || '#4A90D9';
          ctx.strokeStyle = pathColor.replace(')', ',0.15)').replace('rgb', 'rgba').replace('#', '');
          // hex to rgba for path
          const hexToRgba = (hex, a) => {
            const r = parseInt(hex.slice(1,3),16), g = parseInt(hex.slice(3,5),16), b = parseInt(hex.slice(5,7),16);
            return 'rgba('+r+','+g+','+b+','+a+')';
          };
          ctx.strokeStyle = hexToRgba(p.typeColor || '#4A90D9', 0.2);
          ctx.lineWidth = 1;
          ctx.stroke();
        }

        // Dot â€” ìŠ¹ê° ìœ í˜•ë³„ ìƒ‰ìƒ (Eq. 20-22 Health-Aware)
        ctx.beginPath();
        ctx.arc(p.x, p.y, radius, 0, Math.PI * 2);

        if (p.usingExtinguisher) {
          // ì†Œí™”ê¸° ì‚¬ìš© ì¤‘: ì£¼í™©ìƒ‰ + ê¹œë°•ì„
          ctx.fillStyle = p.extPhase === 'extinguish'
            ? (Math.sin(elapsedTime * 8) > 0 ? '#F97316' : '#DC2626')
            : '#F97316';
          ctx.fill();
          // ì†Œí™”ê¸° ì•„ì´ì½˜ í‘œì‹œ
          ctx.fillStyle = '#FFFFFF';
          ctx.font = 'bold 7px sans-serif';
          ctx.fillText('FE', p.x - 6, p.y - 7);
        } else if (isInFire(p.x, p.y)) {
          ctx.fillStyle = '#E53E3E';
          ctx.fill();
        } else {
          ctx.fillStyle = p.typeColor || '#4A90D9';
          ctx.fill();
        }

        // Outline
        ctx.strokeStyle = 'rgba(255,255,255,0.3)';
        ctx.lineWidth = 0.5;
        ctx.stroke();

        // â˜… ë©ˆì¶¤ ê²½ê³  í‘œì‹œ (3ì´ˆ ì´ìƒ ë©ˆì¶˜ ìŠ¹ê°)
        if (p.stuckTimer > 3 && mode === 'evacuating' && !p.usingExtinguisher) {
          const pulseR = 7 + 3 * Math.sin(elapsedTime * 5);
          ctx.beginPath();
          ctx.arc(p.x, p.y, pulseR, 0, Math.PI * 2);
          ctx.strokeStyle = 'rgba(239, 68, 68, ' + (0.4 + 0.3 * Math.sin(elapsedTime * 5)) + ')';
          ctx.lineWidth = 1.5;
          ctx.stroke();
          // SOS í…ìŠ¤íŠ¸
          ctx.fillStyle = '#EF4444';
          ctx.font = 'bold 6px sans-serif';
          ctx.fillText('!', p.x - 2, p.y - 9);
        }
      }
    }

    function drawEvacuatedFlash() {
      // Brief green/blue dot flash at exits and stairways when someone evacuates
      for (const ex of exits) {
        const ecx = ex.x * CELL + ex.w * CELL / 2;
        const ecy = ex.y * CELL + ex.h * CELL / 2;
        ctx.beginPath();
        ctx.arc(ecx, ecy, 3, 0, Math.PI * 2);
        ctx.fillStyle = 'rgba(56, 161, 105, 0.8)';
        ctx.fill();
      }
      for (const sw of stairways) {
        const scx = sw.x * CELL + sw.w * CELL / 2;
        const scy = sw.y * CELL + sw.h * CELL / 2;
        ctx.beginPath();
        ctx.arc(scx, scy, 3, 0, Math.PI * 2);
        ctx.fillStyle = 'rgba(49, 130, 206, 0.8)';
        ctx.fill();
      }
    }

    // â”€â”€â”€â”€â”€ Firefighter System â”€â”€â”€â”€â”€
    function spawnFirefighterTeam(targetFire) {
      // ê°€ì¥ ê°€ê¹Œìš´ ì¶œêµ¬ì—ì„œ ì†Œë°©ê´€ 4ëª… íˆ¬ì…
      const fx = targetFire.x, fy = targetFire.y;
      let bestExit = exits[0];
      let bestDist = Infinity;
      for (const ex of exits) {
        const ecx = ex.x * CELL + ex.w * CELL / 2;
        const ecy = ex.y * CELL + ex.h * CELL / 2;
        const d = Math.sqrt((fx - ecx) ** 2 + (fy - ecy) ** 2);
        if (d < bestDist) { bestDist = d; bestExit = ex; }
      }
      const spawnX = bestExit.x * CELL + bestExit.w * CELL / 2;
      const spawnY = bestExit.y * CELL + bestExit.h * CELL / 2;

      for (let i = 0; i < 4; i++) {
        firefighters.push({
          x: spawnX + (Math.random() - 0.5) * 10,
          y: spawnY + (Math.random() - 0.5) * 10,
          speed: 1.5 + Math.random() * 0.3, // ì†Œë°©ê´€ì€ ë¹ ë¦„
          targetFire: targetFire,
          phase: 'moving',  // moving â†’ suppressing â†’ done
          suppressTimer: 0,
          path: [],
          pathTimer: 0,
          lastX: spawnX,
          lastY: spawnY,
          stuckTimer: 0
        });
      }
    }

    function updateFirefighters(dt) {
      for (const ff of firefighters) {
        if (ff.phase === 'done') continue;

        // ì§„ì•• ì¤‘
        if (ff.phase === 'suppressing') {
          ff.suppressTimer += dt;
          // 5ì´ˆê°„ ì§„ì•• â†’ í™”ì¬ ëŒ€í­ ì¶•ì†Œ
          if (ff.suppressTimer >= 5) {
            ff.targetFire.radius = Math.max(ff.targetFire.radius * 0.15, 2);
            ff.targetFire.smokeRadius = Math.max(ff.targetFire.smokeRadius * 0.1, 3);
            ff.targetFire.startTime = elapsedTime + 9999; // ì¬í™•ì‚° ë°©ì§€
            ff.phase = 'done';
            ffSuppressCount++;
          }
          continue;
        }

        // í™”ì¬ ë°©í–¥ìœ¼ë¡œ ì´ë™ (A* ê²½ë¡œ ì‚¬ìš©)
        const speed = ff.speed * CELL * 2;
        const tfx = ff.targetFire.x, tfy = ff.targetFire.y;
        const distToFire = Math.sqrt((ff.x - tfx) ** 2 + (ff.y - tfy) ** 2);
        const targetDist = ff.targetFire.radius + 15;

        // í™”ì¬ ê·¼ì²˜ ë„ë‹¬ â†’ ì§„ì•• ì‹œì‘
        if (distToFire < targetDist + 10) {
          ff.phase = 'suppressing';
          ff.suppressTimer = 0;
          continue;
        }

        // ê²½ë¡œ íƒìƒ‰
        ff.pathTimer -= dt;
        const movedDx = ff.x - ff.lastX, movedDy = ff.y - ff.lastY;
        if (Math.sqrt(movedDx ** 2 + movedDy ** 2) < 0.5) ff.stuckTimer += dt;
        else ff.stuckTimer = 0;
        ff.lastX = ff.x; ff.lastY = ff.y;

        if (ff.path.length === 0 || ff.pathTimer <= 0 || ff.stuckTimer > 1) {
          // í™”ì¬ ê°€ì¥ ê°€ê¹Œìš´ walkable ì…€ì„ ëª©í‘œë¡œ
          const fireGR = Math.floor(tfy / CELL);
          const fireGC = Math.floor(tfx / CELL);
          let bestTarget = null;
          let bestD = Infinity;
          for (let dr = -3; dr <= 3; dr++) {
            for (let dc = -3; dc <= 3; dc++) {
              const nr = fireGR + dr, nc = fireGC + dc;
              if (isWalkable(nr, nc)) {
                const px = nc * CELL + CELL / 2, py = nr * CELL + CELL / 2;
                const d = Math.sqrt((px - tfx) ** 2 + (py - tfy) ** 2);
                if (d < bestD) { bestD = d; bestTarget = { x: nc, y: nr, w: 1, h: 1 }; }
              }
            }
          }
          if (bestTarget) {
            ff.path = findPath(ff.x, ff.y, bestTarget);
          }
          ff.pathTimer = 0.8;
          ff.stuckTimer = 0;
        }

        // ê²½ë¡œ ë”°ë¼ ì´ë™
        if (ff.path.length > 0) {
          const target = ff.path[0];
          const dx = target.x - ff.x, dy = target.y - ff.y;
          const dist = Math.sqrt(dx * dx + dy * dy);
          const moveAmt = speed * dt;
          if (dist < moveAmt) { ff.x = target.x; ff.y = target.y; ff.path.shift(); }
          else { ff.x += (dx / dist) * moveAmt; ff.y += (dy / dist) * moveAmt; }
        } else {
          // ê²½ë¡œ ì—†ìœ¼ë©´ ì§ì„  ì´ë™
          const dx = tfx - ff.x, dy = tfy - ff.y;
          const dist = Math.sqrt(dx * dx + dy * dy);
          if (dist > 1) {
            ff.x += (dx / dist) * speed * 0.5 * dt;
            ff.y += (dy / dist) * speed * 0.5 * dt;
          }
        }
      }
    }

    function drawFirefighters() {
      for (const ff of firefighters) {
        if (ff.phase === 'done') {
          // ì™„ë£Œ: íŒŒë€ ì²´í¬ í‘œì‹œ
          ctx.fillStyle = 'rgba(37, 99, 235, 0.5)';
          ctx.beginPath();
          ctx.arc(ff.x, ff.y, 5, 0, Math.PI * 2);
          ctx.fill();
          continue;
        }

        // ì†Œë°©ê´€ ëª¸ì²´ (íŒŒë€ìƒ‰ ì‚¬ê°í˜•)
        const size = 6;
        ctx.fillStyle = ff.phase === 'suppressing'
          ? (Math.sin(elapsedTime * 10) > 0 ? '#2563EB' : '#EF4444') // ì§„ì•• ì¤‘: íŒŒë‘/ë¹¨ê°• ê¹œë°•
          : '#2563EB'; // ì´ë™ ì¤‘: íŒŒë€ìƒ‰
        ctx.fillRect(ff.x - size / 2, ff.y - size / 2, size, size);

        // í…Œë‘ë¦¬
        ctx.strokeStyle = '#FFFFFF';
        ctx.lineWidth = 1;
        ctx.strokeRect(ff.x - size / 2, ff.y - size / 2, size, size);

        // í—¬ë©§ (ìƒë‹¨ ë…¸ë€ ë°˜ì›)
        ctx.fillStyle = '#FCD34D';
        ctx.beginPath();
        ctx.arc(ff.x, ff.y - size / 2 - 1, 3, Math.PI, 0);
        ctx.fill();

        // ì§„ì•• ì¤‘ì´ë©´ ë¬¼ì¤„ê¸° íš¨ê³¼
        if (ff.phase === 'suppressing') {
          const tfx = ff.targetFire.x, tfy = ff.targetFire.y;
          const dx = tfx - ff.x, dy = tfy - ff.y;
          const dist = Math.sqrt(dx * dx + dy * dy);
          if (dist > 0) {
            ctx.strokeStyle = 'rgba(59, 130, 246, 0.6)';
            ctx.lineWidth = 2;
            ctx.setLineDash([4, 3]);
            ctx.beginPath();
            ctx.moveTo(ff.x, ff.y);
            ctx.lineTo(ff.x + dx * 0.7, ff.y + dy * 0.7);
            ctx.stroke();
            ctx.setLineDash([]);

            // ë¬¼ë°©ìš¸ íš¨ê³¼
            const splashX = ff.x + dx * 0.6 + (Math.random() - 0.5) * 10;
            const splashY = ff.y + dy * 0.6 + (Math.random() - 0.5) * 10;
            ctx.fillStyle = 'rgba(96, 165, 250, 0.5)';
            ctx.beginPath();
            ctx.arc(splashX, splashY, 2, 0, Math.PI * 2);
            ctx.fill();
          }
        }

        // FF ë¼ë²¨
        ctx.fillStyle = '#FFFFFF';
        ctx.font = 'bold 6px sans-serif';
        ctx.fillText('FF', ff.x - 5, ff.y + 2);
      }
    }

    // â”€â”€â”€â”€â”€ AI Firefighter Recommendation â”€â”€â”€â”€â”€
    function analyzeFirePriority() {
      if (fires.length === 0) return [];

      const analysis = fires.map((f, idx) => {
        const fireNum = idx + 1;

        // 1) í™”ì¬ ë°˜ê²½ ë‚´ ìŠ¹ê° ìˆ˜ (ìœ„í—˜ ìŠ¹ê°)
        let passengersInFire = 0;
        let passengersInSmoke = 0;
        let passengersNearby = 0;  // 150px ì´ë‚´
        let blockedPassengers = 0; // ê²½ë¡œê°€ ì´ í™”ì¬ì— ì˜í•´ ì°¨ë‹¨ëœ ìŠ¹ê°

        for (const p of passengers) {
          if (p.evacuated) continue;
          const dx = p.x - f.x, dy = p.y - f.y;
          const dist = Math.sqrt(dx * dx + dy * dy);
          if (dist < f.radius) passengersInFire++;
          else if (dist < f.smokeRadius) passengersInSmoke++;
          if (dist < 150) passengersNearby++;
          // ê²½ë¡œ ì°¨ë‹¨ ë¶„ì„: ìŠ¹ê°ì˜ ëª©í‘œ ì¶œêµ¬ ë°©í–¥ì— í™”ì¬ê°€ ìˆëŠ”ì§€
          if (p.targetExit) {
            const ecx = p.targetExit.x * CELL + p.targetExit.w * CELL / 2;
            const ecy = p.targetExit.y * CELL + p.targetExit.h * CELL / 2;
            // ìŠ¹ê°â†’ì¶œêµ¬ ì§ì„  ê²½ë¡œì™€ í™”ì¬ì˜ ê±°ë¦¬
            const pathDx = ecx - p.x, pathDy = ecy - p.y;
            const pathLen = Math.sqrt(pathDx * pathDx + pathDy * pathDy);
            if (pathLen > 0) {
              const t = Math.max(0, Math.min(1, ((f.x - p.x) * pathDx + (f.y - p.y) * pathDy) / (pathLen * pathLen)));
              const closestX = p.x + t * pathDx;
              const closestY = p.y + t * pathDy;
              const distToPath = Math.sqrt((f.x - closestX) ** 2 + (f.y - closestY) ** 2);
              if (distToPath < f.radius * 1.5) blockedPassengers++;
            }
          }
          // stuck ìƒíƒœì¸ ìŠ¹ê°ì´ ì´ í™”ì¬ ê·¼ì²˜ì¸ì§€
          if (p.stuckTimer > 2 && dist < 200) blockedPassengers++;
        }

        // 2) ì¶œêµ¬ ì°¨ë‹¨ ë¶„ì„
        let exitBlocked = 0;
        for (const ex of exits) {
          const ecx = ex.x * CELL + ex.w * CELL / 2;
          const ecy = ex.y * CELL + ex.h * CELL / 2;
          const dist = Math.sqrt((f.x - ecx) ** 2 + (f.y - ecy) ** 2);
          if (dist < f.smokeRadius * 1.2) exitBlocked++;
        }

        // 3) í™”ì¬ í¬ê¸°
        const fireSize = f.radius;

        // 4) ì´ë¯¸ ì†Œë°©ê´€ì´ íˆ¬ì…ë˜ì—ˆëŠ”ì§€
        const ffAssigned = firefighters.filter(ff => ff.targetFire === f && ff.phase !== 'done').length;

        // 5) ìš°ì„ ìˆœìœ„ ì ìˆ˜ ê³„ì‚°
        // ë†’ì„ìˆ˜ë¡ ë¨¼ì € íˆ¬ì…í•´ì•¼ í•¨
        const score =
          passengersInFire * 100 +     // í™”ì¬ ì•ˆ ìŠ¹ê° (ìµœìš°ì„ )
          blockedPassengers * 30 +     // ê²½ë¡œ ì°¨ë‹¨ ìŠ¹ê°
          passengersInSmoke * 15 +     // ì—°ê¸° ì˜í–¥ ìŠ¹ê°
          passengersNearby * 5 +       // ê·¼ì ‘ ìŠ¹ê°
          exitBlocked * 40 +           // ì¶œêµ¬ ì°¨ë‹¨
          fireSize * 2 -               // í™”ì¬ í¬ê¸°
          ffAssigned * 80;             // ì´ë¯¸ íˆ¬ì…ëœ ì†Œë°©ê´€ (ê°ì )

        // ìœ„ì¹˜ ì„¤ëª…
        let location = currentDeck + 'ì¸µ';
        const gx = Math.floor(f.x / CELL), gy = Math.floor(f.y / CELL);
        if (gy <= 15) location += ' ìƒë¶€';
        else if (gy <= 30) location += ' ì¤‘ë¶€';
        else location += ' í•˜ë¶€';

        if (gx < 30) location += ' ì¢Œí˜„';
        else if (gx > 60) location += ' ìš°í˜„';
        else location += ' ì¤‘ì•™';

        return {
          fireNum, fire: f, score, location,
          passengersInFire, passengersInSmoke, passengersNearby,
          blockedPassengers, exitBlocked, fireSize: Math.round(fireSize),
          ffAssigned
        };
      });

      // ì ìˆ˜ ë†’ì€ ìˆœìœ¼ë¡œ ì •ë ¬
      analysis.sort((a, b) => b.score - a.score);
      return analysis;
    }

    function showFirefighterRecommendation() {
      const panel = document.getElementById('ffRecommendPanel');
      const content = document.getElementById('ffRecommendContent');

      if (fires.length === 0) {
        panel.style.display = 'none';
        return;
      }

      const analysis = analyzeFirePriority();
      const totalRemaining = passengers.filter(p => !p.evacuated).length;
      const totalStuck = passengers.filter(p => !p.evacuated && p.stuckTimer > 2).length;

      let html = '';

      // ì „ì²´ ìƒí™© ìš”ì•½
      html += '<div style="background:rgba(255,255,255,0.8); border-radius:8px; padding:12px; margin-bottom:12px; border:1px solid #E2E8F0;">';
      html += '<div style="font-weight:700; color:#1E293B; margin-bottom:6px;">ğŸ“Š í˜„ì¬ ìƒí™© ë¶„ì„</div>';
      html += '<div style="display:grid; grid-auto-flow:column; grid-auto-columns:1fr; gap:8px; text-align:center;">';
      html += '<div style="background:#FEE2E2; padding:8px; border-radius:6px;"><div style="font-size:1.1rem; font-weight:700; color:#DC2626;">' + fires.length + '</div><div style="font-size:0.72rem; color:#991B1B;">í™œì„± í™”ì¬</div></div>';
      html += '<div style="background:#DBEAFE; padding:8px; border-radius:6px;"><div style="font-size:1.1rem; font-weight:700; color:#2563EB;">' + totalRemaining + '</div><div style="font-size:0.72rem; color:#1E40AF;">ì”ë¥˜ ìŠ¹ê°</div></div>';
      html += '<div style="background:#FEF3C7; padding:8px; border-radius:6px;"><div style="font-size:1.1rem; font-weight:700; color:#D97706;">' + totalStuck + '</div><div style="font-size:0.72rem; color:#92400E;">ì´ë™ë¶ˆê°€</div></div>';
      html += '<div style="background:#D1FAE5; padding:8px; border-radius:6px;"><div style="font-size:1.1rem; font-weight:700; color:#059669;">' + firefighters.filter(ff => ff.phase !== 'done').length + '</div><div style="font-size:0.72rem; color:#065F46;">í™œë™ ì†Œë°©ê´€</div></div>';
      html += '</div></div>';

      // ê° í™”ì¬ë³„ ë¶„ì„ ì¹´ë“œ
      html += '<div style="display:flex; flex-direction:column; gap:10px;">';

      analysis.forEach((a, idx) => {
        const isTop = idx === 0;
        const borderColor = isTop ? '#DC2626' : '#94A3B8';
        const bgColor = isTop ? 'rgba(254,226,226,0.4)' : 'rgba(255,255,255,0.7)';
        const badge = isTop
          ? '<span style="background:#DC2626; color:#fff; font-size:0.7rem; font-weight:700; padding:2px 8px; border-radius:10px; margin-left:8px;">ğŸ¯ ìµœìš°ì„  íˆ¬ì… ì¶”ì²œ</span>'
          : (idx === 1 ? '<span style="background:#D97706; color:#fff; font-size:0.7rem; font-weight:700; padding:2px 8px; border-radius:10px; margin-left:8px;">2ìˆœìœ„</span>' : '');

        html += '<div style="background:' + bgColor + '; border:1.5px solid ' + borderColor + '; border-radius:10px; padding:12px;">';
        html += '<div style="display:flex; align-items:center; margin-bottom:8px;">';
        html += '<span style="font-weight:700; font-size:0.95rem; color:#DC2626;">ğŸ”¥ Fire #' + a.fireNum + '</span>';
        html += '<span style="font-size:0.78rem; color:#64748B; margin-left:10px;">' + a.location + '</span>';
        html += badge;
        if (a.ffAssigned > 0) {
          html += '<span style="background:#DBEAFE; color:#1D4ED8; font-size:0.7rem; font-weight:600; padding:2px 8px; border-radius:10px; margin-left:6px;">ğŸš’ ' + a.ffAssigned + 'ëª… íˆ¬ì…ë¨</span>';
        }
        html += '</div>';

        // ìœ„í—˜ë„ ì§€í‘œ
        html += '<div style="display:grid; grid-template-columns:repeat(5,1fr); gap:6px; margin-bottom:8px;">';
        html += '<div style="text-align:center; padding:4px; background:rgba(220,38,38,0.1); border-radius:4px;"><div style="font-weight:700; color:#DC2626; font-size:0.9rem;">' + a.passengersInFire + '</div><div style="font-size:0.65rem; color:#7F1D1D;">í™”ì¬ ë‚´</div></div>';
        html += '<div style="text-align:center; padding:4px; background:rgba(100,100,100,0.1); border-radius:4px;"><div style="font-weight:700; color:#475569; font-size:0.9rem;">' + a.passengersInSmoke + '</div><div style="font-size:0.65rem; color:#334155;">ì—°ê¸° ë‚´</div></div>';
        html += '<div style="text-align:center; padding:4px; background:rgba(217,119,6,0.1); border-radius:4px;"><div style="font-weight:700; color:#D97706; font-size:0.9rem;">' + a.blockedPassengers + '</div><div style="font-size:0.65rem; color:#92400E;">ê²½ë¡œì°¨ë‹¨</div></div>';
        html += '<div style="text-align:center; padding:4px; background:rgba(37,99,235,0.1); border-radius:4px;"><div style="font-weight:700; color:#2563EB; font-size:0.9rem;">' + a.exitBlocked + '</div><div style="font-size:0.65rem; color:#1E40AF;">ì¶œêµ¬ìœ„í˜‘</div></div>';
        html += '<div style="text-align:center; padding:4px; background:rgba(229,62,62,0.08); border-radius:4px;"><div style="font-weight:700; color:#E53E3E; font-size:0.9rem;">' + a.fireSize + 'px</div><div style="font-size:0.65rem; color:#7F1D1D;">ë°˜ê²½</div></div>';
        html += '</div>';

        // AI íŒë‹¨ ì´ìœ 
        let reason = '';
        if (isTop) {
          const reasons = [];
          if (a.passengersInFire > 0) reasons.push('í™”ì¬ ë‚´ ' + a.passengersInFire + 'ëª…ì˜ ìŠ¹ê°ì´ ì¦‰ê° ìœ„í—˜');
          if (a.blockedPassengers > 3) reasons.push('ë‹¤ìˆ˜(' + a.blockedPassengers + 'ëª…)ì˜ ëŒ€í”¼ ê²½ë¡œë¥¼ ì°¨ë‹¨');
          if (a.exitBlocked > 0) reasons.push(a.exitBlocked + 'ê°œ ë¹„ìƒêµ¬ ìœ„í˜‘');
          if (a.fireSize > 60) reasons.push('í™”ì¬ ë°˜ê²½ ' + a.fireSize + 'pxë¡œ ê¸‰ì† í™•ì‚° ì¤‘');
          if (a.passengersNearby > 10) reasons.push('ì£¼ë³€ 150px ë‚´ ' + a.passengersNearby + 'ëª… ë°€ì§‘');
          if (reasons.length === 0) reasons.push('ì¢…í•© ìœ„í—˜ë„ ì ìˆ˜ê°€ ê°€ì¥ ë†’ìŒ');
          reason = '<div style="font-size:0.78rem; color:#1D4ED8; background:rgba(37,99,235,0.08); padding:6px 10px; border-radius:6px; border-left:3px solid #2563EB;">';
          reason += '<b>AI íŒë‹¨:</b> ' + reasons.join(', ') + '. ì´ í™”ì¬ë¥¼ ë¨¼ì € ì§„ì••í•˜ë©´ ìŠ¹ê° ëŒ€í”¼ íš¨ìœ¨ì´ í¬ê²Œ í–¥ìƒë©ë‹ˆë‹¤.';
          reason += '</div>';
        }
        html += reason;
        html += '</div>';
      });

      html += '</div>';

      // íˆ¬ì… ì•ˆë‚´
      html += '<div style="margin-top:12px; padding:10px; background:rgba(37,99,235,0.08); border-radius:8px; font-size:0.8rem; color:#1D4ED8; text-align:center;">';
      html += 'ğŸ’¡ ìº”ë²„ìŠ¤ì—ì„œ ì§„ì••í•  í™”ì¬ ê·¼ì²˜ë¥¼ í´ë¦­í•˜ë©´ ì†Œë°©ê´€ 4ëª…ì´ íˆ¬ì…ë©ë‹ˆë‹¤. ì—¬ëŸ¬ í™”ì¬ì— ë°˜ë³µ íˆ¬ì… ê°€ëŠ¥í•©ë‹ˆë‹¤.';
      html += '</div>';

      panel.style.display = 'block';
      content.innerHTML = html;
    }

    // â”€â”€â”€â”€â”€ UI Updates â”€â”€â”€â”€â”€
    function updateStats(atRisk) {
      const activePassengers = passengers.filter(p => !p.evacuated);
      const total = passengers.length;

      statEvacuated.textContent = evacuatedCount;
      statRemaining.textContent = activePassengers.length;
      statAtRisk.textContent = atRisk;
      statTime.textContent = elapsedTime.toFixed(1) + 's';

      if (evacuationTimes.length > 0) {
        const avg = evacuationTimes.reduce((a, b) => a + b, 0) / evacuationTimes.length;
        statAvgTime.textContent = avg.toFixed(1) + 's';
      }

      // Danger zones count (grid cells in fire)
      let dangerCount = 0;
      for (const f of fires) {
        dangerCount += Math.ceil(f.radius / CELL);
      }
      statDangerZones.textContent = dangerCount;

      const pct = total > 0 ? Math.round((evacuatedCount / total) * 100) : 0;
      progPercent.textContent = pct + '%';
      progBar.style.width = pct + '%';

      statFireCount.textContent = fires.length;
      if (fires.length > 0) {
        const maxR = Math.max(...fires.map(f => f.radius));
        statFireRadius.textContent = Math.round(maxR) + 'px';
      } else {
        statFireRadius.textContent = '0px';
      }

      // ê°€ì‹œì„± í†µê³„ (Beer-Lambert, Eq. 10)
      const activeP = passengers.filter(p => !p.evacuated);
      if (activeP.length > 0 && fires.length > 0) {
        const totalVis = activeP.reduce((sum, p) => sum + calcVisibility(p.x, p.y), 0);
        const avgVis = totalVis / activeP.length;
        const visEl = document.getElementById('statVisibility');
        visEl.textContent = avgVis.toFixed(1) + 'm';
        visEl.style.color = avgVis < 5 ? 'var(--danger)' : avgVis < 15 ? 'var(--warning)' : 'var(--safe)';
      }

      // ìŠ¹ê° ìœ í˜• ë¶„í¬ í‘œì‹œ
      if (passengers.length > 0) {
        const typeCounts = {};
        for (const p of passengers) {
          typeCounts[p.typeKey] = (typeCounts[p.typeKey] || 0) + 1;
        }
        const parts = [];
        const labels = {normal:'ì„±ì¸',elderly:'ê³ ë ¹',child:'ì•„ë™',wheelchair:'íœ ì²´ì–´',pregnant:'ì„ì‚°',injured:'ë¶€ìƒ'};
        for (const [k, v] of Object.entries(typeCounts)) {
          parts.push((labels[k]||k) + ':' + v);
        }
        document.getElementById('statTypeDist').textContent = parts.join(' ');
      }

      // ì†Œí™”ê¸° í†µê³„
      const feAvail = fireExtinguishers.filter(fe => fe.available).length;
      const feTotal = fireExtinguishers.length;
      document.getElementById('statFECount').textContent = feAvail + '/' + feTotal;
      const feActive = passengers.filter(p => p.usingExtinguisher).length;
      document.getElementById('statFEActive').textContent = feActive + 'ëª…';

      // ë©ˆì¶¤ ìŠ¹ê° ìˆ˜
      const stuckCount = passengers.filter(p => !p.evacuated && p.stuckTimer > 3 && !p.usingExtinguisher).length;
      document.getElementById('statStuck').textContent = stuckCount + 'ëª…';

      // ì†Œë°©ê´€ í†µê³„
      const activeFF = firefighters.filter(f => f.phase !== 'done').length;
      document.getElementById('statFF').textContent = firefighters.length + 'ëª… (' + activeFF + 'í™œë™)';
      document.getElementById('statFFDone').textContent = ffSuppressCount + 'ê±´';

      // Check done
      if (mode === 'evacuating' && activePassengers.length === 0) {
        mode = 'done';
        statMode.textContent = 'ëŒ€í”¼ ì™„ë£Œ!';
        statMode.style.color = 'var(--safe)';
      }
    }

    // â”€â”€â”€â”€â”€ Main Loop â”€â”€â”€â”€â”€
    function loop(timestamp) {
      if (!lastFrameTime) lastFrameTime = timestamp;
      const rawDt = (timestamp - lastFrameTime) / 1000;
      lastFrameTime = timestamp;
      const dt = rawDt * simSpeed;

      if (mode === 'evacuating' || fires.length > 0) {
        elapsedTime += dt;
      }

      // Update
      updateFires(dt);
      const atRisk = updatePassengers(dt);
      updateFirefighters(dt);

      // Draw
      ctx.clearRect(0, 0, W, H);
      drawShip();
      drawFires();
      drawRiskMapOverlay();
      drawFirefighters();
      drawPassengers();
      drawEvacuatedFlash();
      updateStats(atRisk);

      animId = requestAnimationFrame(loop);
    }

    // â”€â”€â”€â”€â”€ Event Handlers â”€â”€â”€â”€â”€
    function getCanvasCoords(e) {
      const rect = canvas.getBoundingClientRect();
      const scaleX = W / rect.width;
      const scaleY = H / rect.height;
      return {
        x: (e.clientX - rect.left) * scaleX,
        y: (e.clientY - rect.top) * scaleY
      };
    }

    canvas.addEventListener('click', function (e) {
      const coords = getCanvasCoords(e);

      // ì†Œë°©ê´€ ë°°ì¹˜ ëª¨ë“œ
      if (ffDeployMode) {
        // í´ë¦­ ìœ„ì¹˜ì— ê°€ì¥ ê°€ê¹Œìš´ í™”ì¬ ì°¾ê¸°
        let nearestFire = null;
        let nearestDist = Infinity;
        for (const f of fires) {
          const d = Math.sqrt((coords.x - f.x) ** 2 + (coords.y - f.y) ** 2);
          if (d < nearestDist) { nearestDist = d; nearestFire = f; }
        }
        if (nearestFire && nearestDist < 200) {
          spawnFirefighterTeam(nearestFire);
          ffBadge.style.display = 'inline-block';
          ffBadge.textContent = firefighters.length + 'ëª… íˆ¬ì…';
          ffDeployMode = false;
          btnFirefighter.classList.remove('active-mode');
          canvas.style.cursor = 'default';
          overlay.classList.add('hidden');
          // íˆ¬ì… í›„ ì¶”ì²œ ê°±ì‹ 
          showFirefighterRecommendation();
        } else {
          overlay.innerHTML = '<b style="color:#2563EB;">í™”ì¬ ê·¼ì²˜ë¥¼ í´ë¦­í•˜ì„¸ìš”!</b><br>' +
            '<span style="font-size:0.85rem;">í™”ì¬ ì§€ì  ì£¼ë³€ì„ í´ë¦­í•˜ë©´ ì†Œë°©ê´€ 4ëª…ì´ íˆ¬ì…ë©ë‹ˆë‹¤</span>';
        }
        return;
      }

      // í™”ì¬ ë°°ì¹˜ ëª¨ë“œ
      if (mode !== 'placing') return;
      addFire(coords.x, coords.y);
      statFireCount.textContent = fires.length;
      fireCountBadge.style.display = 'inline-block';
      fireCountBadge.textContent = fires.length + 'ê°œ ë°°ì¹˜';
      btnEvac.disabled = false;
      overlay.innerHTML = '<b style="color:#DC2626;font-size:1.1rem;">' + fires.length + 'ê°œ í™”ì¬ ë°°ì¹˜ ì™„ë£Œ</b><br>' +
        '<span style="font-size:0.85rem;">í´ë¦­í•˜ì—¬ ì¶”ê°€ ë°°ì¹˜ ê°€ëŠ¥</span><br>' +
        '<span style="font-size:0.8rem;color:#64748B;">ì¤€ë¹„ë˜ë©´ "ëŒ€í”¼ ì‹œì‘" ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”</span>';
    });

    btnFire.addEventListener('click', function () {
      if (mode === 'idle' || mode === 'placing') {
        mode = 'placing';
        statMode.textContent = 'í™”ì¬ ë°°ì¹˜ ëª¨ë“œ';
        statMode.style.color = 'var(--danger)';
        overlay.classList.remove('hidden');
        if (fires.length === 0) {
          overlay.innerHTML = 'ë± ìœ„ë¥¼ í´ë¦­í•˜ì—¬ í™”ì¬ë¥¼ ë°°ì¹˜í•˜ì„¸ìš”<br>' +
            '<span style="font-size:0.85rem;font-weight:600;color:#DC2626;">ì—¬ëŸ¬ ê³³ì— ë™ì‹œ ë‹¤ë°œ í™”ì¬ ë°°ì¹˜ ê°€ëŠ¥</span><br>' +
            '<span style="font-size:0.8rem;color:#64748B;">ì›í•˜ëŠ” ë§Œí¼ í´ë¦­í•œ í›„ "ëŒ€í”¼ ì‹œì‘"ì„ ëˆ„ë¥´ì„¸ìš”</span>';
        } else {
          overlay.innerHTML = '<b style="color:#DC2626;font-size:1.1rem;">' + fires.length + 'ê°œ í™”ì¬ ë°°ì¹˜ ì™„ë£Œ</b><br>' +
            '<span style="font-size:0.85rem;">í´ë¦­í•˜ì—¬ ì¶”ê°€ ë°°ì¹˜ ê°€ëŠ¥</span><br>' +
            '<span style="font-size:0.8rem;color:#64748B;">ì¤€ë¹„ë˜ë©´ "ëŒ€í”¼ ì‹œì‘" ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”</span>';
        }
        btnFire.classList.add('active-mode');
        canvas.style.cursor = 'crosshair';
      }
    });

    btnEvac.addEventListener('click', function () {
      if (fires.length === 0) return;
      mode = 'evacuating';
      statMode.textContent = 'ëŒ€í”¼ ì§„í–‰ ì¤‘... (í™”ì¬ ' + fires.length + 'ê°œ)';
      statMode.style.color = 'var(--warning)';
      overlay.classList.add('hidden');
      btnFire.classList.remove('active-mode');
      btnFire.disabled = true;
      btnEvac.disabled = true;
      btnFirefighter.disabled = false; // ì†Œë°©ê´€ íˆ¬ì… ë²„íŠ¼ í™œì„±í™”
      canvas.style.cursor = 'default';
      fireCountBadge.style.background = '#FEF3C7';
      fireCountBadge.style.color = '#D97706';
      fireCountBadge.style.borderColor = '#FDE68A';
    });

    btnFirefighter.addEventListener('click', function () {
      if (mode !== 'evacuating' && mode !== 'done') return;
      ffDeployMode = !ffDeployMode;
      if (ffDeployMode) {
        btnFirefighter.classList.add('active-mode');
        canvas.style.cursor = 'crosshair';
        overlay.classList.remove('hidden');
        overlay.innerHTML = '<b style="color:#2563EB;font-size:1.1rem;">ğŸš’ ì†Œë°©ê´€ íˆ¬ì… ëª¨ë“œ</b><br>' +
          '<span style="font-size:0.85rem;">ì§„ì••í•  í™”ì¬ ê·¼ì²˜ë¥¼ í´ë¦­í•˜ì„¸ìš”</span><br>' +
          '<span style="font-size:0.8rem;color:#64748B;">ì†Œë°©ê´€ 4ëª…ì´ ê°€ì¥ ê°€ê¹Œìš´ ì¶œêµ¬ì—ì„œ ì§„ì…í•©ë‹ˆë‹¤</span>';
        // AI ì¶”ì²œ ë¶„ì„ í‘œì‹œ
        showFirefighterRecommendation();
      } else {
        btnFirefighter.classList.remove('active-mode');
        canvas.style.cursor = 'default';
        overlay.classList.add('hidden');
      }
    });

    btnReset.addEventListener('click', function () {
      resetSimulation();
    });

    // ìœ„í—˜ì§€ë„ ì˜¤ë²„ë ˆì´ í† ê¸€ (Eq. 11)
    document.getElementById('btnRiskMap').addEventListener('click', function () {
      showRiskMap = !showRiskMap;
      this.classList.toggle('active-mode', showRiskMap);
      this.style.boxShadow = showRiskMap ? '0 0 0 2px #7C3AED' : 'none';
    });

    speedSlider.addEventListener('input', function () {
      simSpeed = parseFloat(this.value);
      speedVal.textContent = simSpeed + 'x';
    });

    countInput.addEventListener('input', function () {
      const val = parseInt(this.value);
      if (!isNaN(val) && val >= 1) {
        passengerCount = val;
        if (mode === 'idle') {
          spawnPassengers();
        }
      }
    });

    // â”€â”€â”€â”€â”€ Reset â”€â”€â”€â”€â”€
    function resetSimulation() {
      mode = 'idle';
      fires = [];
      firefighters = [];
      ffDeployMode = false;
      ffSuppressCount = 0;
      for (const fe of fireExtinguishers) fe.available = true;
      evacuatedCount = 0;
      elapsedTime = 0;
      evacuationTimes = [];
      lastFrameTime = 0;
      btnFire.disabled = false;
      btnEvac.disabled = true;
      btnFirefighter.disabled = true;
      btnFirefighter.classList.remove('active-mode');
      ffBadge.style.display = 'none';
      document.getElementById('ffRecommendPanel').style.display = 'none';
      btnFire.classList.remove('active-mode');
      canvas.style.cursor = 'default';
      overlay.classList.remove('hidden');
      overlay.innerHTML = 'í™”ì¬ ìœ„ì¹˜ë¥¼ í´ë¦­í•˜ì—¬ ì„¤ì •í•˜ì„¸ìš”<br><span style="font-size:0.8rem;">"í™”ì¬ ë°°ì¹˜ ëª¨ë“œ" ë²„íŠ¼ì„ ë¨¼ì € ëˆ„ë¥´ì„¸ìš”</span>';
      statMode.textContent = 'ëŒ€ê¸° ì¤‘';
      statMode.style.color = 'var(--text-primary)';
      statFireCount.textContent = '0';
      statFireRadius.textContent = '0px';
      fireCountBadge.style.display = 'none';
      fireCountBadge.textContent = '0ê°œ ë°°ì¹˜';
      progBar.style.width = '0%';
      progPercent.textContent = '0%';
      statAvgTime.textContent = '--';

      buildShipLayout();
      spawnPassengers();
    }

    // â”€â”€â”€â”€â”€ Deck Selection â”€â”€â”€â”€â”€
    function switchDeck(deckNum) {
      currentDeck = deckNum;
      // ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ì—…ë°ì´íŠ¸
      document.querySelectorAll('.deck-btn').forEach(btn => {
        btn.classList.toggle('active', parseInt(btn.dataset.deck) === deckNum);
      });
      // ì‹œë®¬ë ˆì´ì…˜ ì´ˆê¸°í™”
      resetSimulation();
    }
    // ì „ì—­ ì ‘ê·¼ìš©
    window.selectDeck = switchDeck;

    // â”€â”€â”€â”€â”€ Init â”€â”€â”€â”€â”€
    buildShipLayout();
    spawnPassengers();
    animId = requestAnimationFrame(loop);

  })();
  </script>

    <!-- FOOTER -->
    <footer class="footer">
      <div class="footer-brand">FireNavi &#x1F525; í™”ì´ì–´ë‚´ë¹„</div>
      <p>í˜¸í™”ìœ ëŒì„  í™”ì¬ ëŒ€í”¼ AI ë‚´ë¹„ê²Œì´ì…˜ ì†”ë£¨ì…˜ &copy; 2026</p>
      <p style="margin-top:4px;">Patented Technology &middot; All Rights Reserved</p>
    </footer>
  </div>

  <script src="../js/main.js"></script>
</body>
</html>